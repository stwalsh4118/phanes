# 8-3 Implement profile selection and validation

[Back to task list](./tasks.md)

## Description

Implement profile selection logic that validates the profile exists, resolves module names from the profile, and handles errors gracefully. This connects the profile package to the CLI.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 00:00:00 | Created | N/A | Proposed | Task file created | sean |
| 2025-01-27 23:35:00 | Status Update | Proposed | InProgress | Started implementation | sean |
| 2025-01-27 23:35:00 | Status Update | InProgress | Review | Implementation complete, all tests passing | sean |
| 2025-01-27 23:40:00 | Status Update | Review | Done | Task approved and completed | sean |

## Requirements

1. Use `profile.GetProfile(name)` from `internal/profile` package
2. Validate profile exists before using it
3. Handle profile not found errors with clear messages
4. Return list of module names from profile
5. Log profile selection and module list
6. Use `profile.ProfileExists()` or check error from `GetProfile()`

## Implementation Plan

1. Create `getProfileModules(profileName string) ([]string, error)` function in `main.go`
2. Validate profile exists:
   - Option 1: Call `profile.ProfileExists(profileName)` first
   - Option 2: Call `profile.GetProfile(profileName)` and check error
3. If profile doesn't exist:
   - Log error with available profiles list
   - Return error
4. If profile exists:
   - Call `profile.GetProfile(profileName)`
   - Log info message showing selected profile and modules
   - Return module list
5. Call `getProfileModules()` from `runCommand()` when `--profile` Cobra flag is set
6. Store module list for later execution

## Verification

1. Valid profile name resolves to correct module list
2. Invalid profile name shows clear error with available profiles
3. Profile selection is logged correctly
4. Module list is returned correctly
5. Error handling is graceful

## Test Plan

1. **Valid profile**: Test with "minimal" profile, verify correct modules returned
2. **Invalid profile**: Test with "nonexistent", verify error message
3. **Profile listing**: Verify error message includes available profiles
4. **Module logging**: Verify selected modules are logged

## Files Modified

- `main.go` (updated) - Added `getProfileModules()` function and integrated profile selection into `runCommand()`

## Implementation Notes

### Implementation Details

1. **Profile selection function**:
   - Created `getProfileModules(profileName string) ([]string, error)` function in `main.go`
   - Uses `profile.ProfileExists()` to validate profile exists before attempting to retrieve it
   - If profile doesn't exist: Gets available profiles using `profile.ListProfiles()` and returns error with helpful message
   - If profile exists: Calls `profile.GetProfile()` to get module list and logs selection

2. **Error handling**:
   - Profile not found: Logs error messages showing requested profile and available profiles list
   - Returns error with clear message including available profiles
   - Handles edge case where `ProfileExists()` returns true but `GetProfile()` fails (shouldn't happen, but handled defensively)

3. **Integration**:
   - `getProfileModules()` is called from `runCommand()` when `--profile` flag is set
   - Profile modules are stored in `profileModules` variable for later use in subsequent tasks
   - Error from profile selection is wrapped and returned to caller

4. **Logging**:
   - Logs info message when profile is selected: "Profile selected: {name}"
   - Logs info message showing all modules in profile: "Profile modules: {module1, module2, ...}"
   - Logs error messages when profile not found, including available profiles list

### Code Quality

- ✅ `go build` - Code compiles successfully
- ✅ `go vet` - No static analysis issues
- ✅ No linter errors
- ✅ Proper error handling (no panics)
- ✅ Clear error messages with actionable information
- ✅ Follows Go best practices

### Verification Results

1. ✅ Valid profile name ("minimal") resolves to correct module list: `["baseline", "user", "security", "swap", "updates"]`
2. ✅ Invalid profile name ("nonexistent") shows clear error with available profiles list
3. ✅ Profile selection is logged correctly with profile name and module list
4. ✅ Module list is returned correctly as `[]string`
5. ✅ Error handling is graceful with helpful error messages

### Test Results

All test scenarios pass:
- **Valid profile ("minimal")**: Correctly resolves to 5 modules and logs selection
- **Valid profile ("dev")**: Correctly resolves to 8 modules and logs selection
- **Invalid profile ("nonexistent")**: Shows clear error message with available profiles: "coolify, database, dev, minimal, web"
- **Module logging**: Selected modules are logged in comma-separated format

