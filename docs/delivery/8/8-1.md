# 8-1 Create main.go structure with flag parsing

[Back to task list](./tasks.md)

## Description

Create the main entry point (`main.go`) with command-line flag parsing, help text, and basic CLI structure. This establishes the foundation for the CLI interface.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 00:00:00 | Created | N/A | Proposed | Task file created | sean |
| 2025-01-27 15:26:00 | Status Update | Proposed | InProgress | Started implementation | sean |
| 2025-01-27 15:26:00 | Status Update | InProgress | Review | Implementation complete, all tests passing | sean |
| 2025-01-27 15:30:00 | Status Update | Review | Done | Task approved and completed | sean |

## Requirements

1. File located at `main.go` (project root)
2. Define command-line flags:
   - `--profile` (string): Profile name to execute
   - `--modules` (string): Comma-separated list of module names
   - `--config` (string): Path to config file (default: "config.yaml")
   - `--dry-run` (bool): Enable dry-run mode
   - `--list` (bool): List available modules and profiles
3. Implement `main()` function
4. Implement `printHelp()` function with comprehensive usage information
5. Parse flags and validate basic flag combinations
6. Use Cobra CLI framework for structured command handling
7. Exit with appropriate codes (0 for success, 1 for errors, 2 for invalid usage)

## Implementation Plan

1. Create `main.go` at project root
2. Add Cobra dependency: `go get github.com/spf13/cobra`
3. Import required packages: `github.com/spf13/cobra`, `fmt`, `os`, `internal/log`
4. Create root command with Cobra:
   - Define command with Use, Short, Long, Version fields
   - Set up RunE function to handle command execution
5. Define flags using Cobra's flag system:
   - `--profile` (string): Profile name to execute
   - `--modules` (string): Comma-separated list of module names
   - `--config` (string): Path to config file (default: "config.yaml")
   - `--dry-run` (bool): Enable dry-run mode
   - `--list` (bool): List available modules and profiles
6. Implement `runCommand()` function:
   - Set up logging (call `log.SetDryRun()` if dry-run flag is set)
   - Handle --list flag (placeholder for task 8-5)
   - Basic validation (require either profile or modules unless --list)
   - Log selected flags
   - For now, just parse and validate - actual execution will be in later tasks
7. Implement `main()`:
   - Execute root command
   - Handle errors with appropriate exit codes

## Verification

1. `main.go` compiles without errors
2. Help text displays correctly when running `./phanes --help` or with no args
3. All flags parse correctly
4. Flag validation works (invalid combinations show error)
5. Dry-run flag sets logging dry-run mode correctly

## Test Plan

1. **Compilation**: Verify `go build` succeeds
2. **Help text**: Run with `--help` or no args, verify help displays
3. **Flag parsing**: Test each flag individually
4. **Flag validation**: Test invalid combinations (if any)
5. **Dry-run integration**: Verify `log.SetDryRun()` is called when flag is set

## Files Modified

- `main.go` (new) - Created CLI entry point using Cobra with flag parsing, help text, and basic validation
- `go.mod` (updated) - Added github.com/spf13/cobra dependency

## Implementation Notes

### Implementation Details

1. **Created main.go structure**:
   - Defined all required flags: `--profile`, `--modules`, `--config`, `--dry-run`, `--list`
   - Used Cobra CLI framework for structured command handling
   - Set default config path to `config.yaml`
   - Leveraged Cobra's automatic help text generation

2. **Help text implementation**:
   - Used Cobra's built-in help text generation
   - Configured command with Short, Long, and Example fields
   - Cobra automatically generates help with `--help` flag
   - Includes program description, all flags, and usage examples

3. **Flag parsing and validation**:
   - Parses all flags using Cobra's flag system
   - Validates that either `--profile` or `--modules` is specified (unless `--list` is used)
   - Warns if both profile and modules are specified (will be handled in later tasks)
   - Sets up dry-run mode for logging when `--dry-run` flag is set
   - Returns error for invalid usage (exit code 2)

4. **Dry-run integration**:
   - Calls `log.SetDryRun(true)` when `--dry-run` flag is set
   - Logs a message indicating dry-run mode is enabled
   - All subsequent log messages include `dry_run=true` field

5. **Exit codes**:
   - Exit code 0: Success (or when `--list` is used)
   - Exit code 2: Invalid usage (when neither profile nor modules specified)

### Code Quality

- ✅ `go build` - Code compiles without errors
- ✅ `go vet` - No static analysis issues
- ✅ No linter errors
- ✅ Proper error handling
- ✅ Follows Go best practices
- ✅ Uses Cobra CLI framework for structured command handling

### Verification Results

1. ✅ `main.go` compiles without errors
2. ✅ Help text displays correctly when running `./phanes --help` or with no args
3. ✅ All flags parse correctly
4. ✅ Flag validation works (shows error when neither profile nor modules specified)
5. ✅ Dry-run flag sets logging dry-run mode correctly (verified with test runs)
6. ✅ Exit codes are correct (0 for success, 2 for invalid usage)
7. ✅ Warning shown when both profile and modules are specified

