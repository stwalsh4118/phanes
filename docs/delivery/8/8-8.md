# 8-8 Add error handling and exit codes

[Back to task list](./tasks.md)

## Description

Implement comprehensive error handling throughout the CLI with clear, actionable error messages and proper exit codes. This ensures users get helpful feedback when things go wrong.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 00:00:00 | Created | N/A | Proposed | Task file created | sean |
| 2025-01-27 02:09:00 | Status Update | Proposed | InProgress | Started implementation | sean |
| 2025-01-27 02:09:00 | Status Update | InProgress | Review | Implementation complete, all tests passing | sean |
| 2025-01-27 02:15:00 | Status Update | Review | Done | Task approved and completed | sean |

## Requirements

1. Handle all error cases with clear messages:
   - Config file errors (not found, invalid YAML, validation failures)
   - Profile errors (not found, invalid)
   - Module errors (not found, execution failures)
   - Flag validation errors
2. Use `log.Error()` for all errors
3. Exit codes:
   - 0: Success
   - 1: Error (general error)
   - 2: Invalid usage (wrong flags, etc.)
4. Provide actionable error messages (suggest fixes, show available options)
5. Handle panics gracefully (recover if needed)

## Implementation Plan

1. Review all error paths in `main.go` (specifically in `runCommand()` function):
   - Config loading errors
   - Profile selection errors
   - Module parsing errors
   - Module execution errors
   - Flag validation errors
2. Add error handling wrapper or helper:
   - Create `handleError(err error, message string, exitCode int)` function
   - Log error with context
   - Exit with appropriate code
3. Update all error handling:
   - Config loading: Show file path, suggest checking file exists
   - Profile errors: Show available profiles
   - Module errors: Show available modules (if possible)
   - Execution errors: Show which module failed
4. Add panic recovery in `runCommand()` or `main()`:
   - Recover from panics
   - Log panic message
   - Exit with code 1
5. Test error scenarios:
   - Invalid config file
   - Invalid profile
   - Invalid module
   - Execution failure

## Verification

1. All errors are handled gracefully
2. Error messages are clear and actionable
3. Exit codes are correct (0 for success, 1/2 for errors)
4. Panics are recovered and logged
5. Users can understand what went wrong and how to fix it

## Test Plan

1. **Config errors**: Test invalid config file, verify clear error
2. **Profile errors**: Test invalid profile, verify shows available profiles
3. **Module errors**: Test invalid module, verify shows available modules
4. **Execution errors**: Test module execution failure, verify error message
5. **Exit codes**: Verify correct exit codes for each error type
6. **Panic recovery**: Test panic scenario, verify recovery

## Files Modified

- `main.go` (updated) - Added comprehensive error handling, panic recovery, improved error messages, and proper exit codes

## Implementation Notes

### Implementation Details

1. **Error Type Definition**:
   - Created `usageError` type to distinguish usage errors (exit code 2) from general errors (exit code 1)
   - Used `errors.As()` to check for usage errors in `main()`

2. **Panic Recovery**:
   - Added panic recovery in `runCommand()` using `defer` and `recover()`
   - Added panic recovery in `main()` as a safety net
   - Panics are logged and program exits with code 1

3. **Config Error Handling**:
   - **File not found**: Shows file path and suggests checking if file exists
   - **Invalid YAML**: Shows file path, error details, and suggests checking YAML syntax
   - **Validation errors**: Shows which field is missing and provides specific guidance (e.g., "Please add 'username' field under 'user' section")
   - All config errors use `log.Error()` with actionable messages

4. **Profile Error Handling**:
   - Shows profile name that wasn't found
   - Lists all available profiles
   - Suggests using `--list` flag to see all available profiles and modules
   - Uses `log.Error()` for all error messages

5. **Module Error Handling**:
   - **Unknown module**: Shows error details, lists available modules, suggests using `--list` flag
   - **Execution failures**: Shows which module failed with clear error messages
   - All module errors use `log.Error()` with actionable messages

6. **Exit Code Handling**:
   - **Exit code 0**: Success (including `--list` flag)
   - **Exit code 2**: Invalid usage (no profile/modules specified, usage errors)
   - **Exit code 1**: General errors (config errors, profile errors, module errors, execution failures)
   - `main()` function checks error type and sets appropriate exit code

7. **Error Message Improvements**:
   - All errors use `log.Error()` for consistent error logging
   - Error messages include actionable suggestions (e.g., "Use --list to see all available modules")
   - Error messages show available options when applicable (profiles, modules)
   - Error messages provide specific guidance for fixing issues (e.g., which config field is missing)

### Code Quality

- ✅ `go build` - Code compiles successfully
- ✅ `go vet` - No static analysis issues in main.go
- ✅ Proper error handling with context
- ✅ Follows Go best practices
- ✅ Panic recovery implemented at multiple levels
- ✅ All errors use `log.Error()` as required

### Verification Results

1. ✅ **Invalid usage** (no profile/modules): Exit code 2, clear error message
2. ✅ **Invalid profile**: Exit code 1, shows available profiles, suggests `--list`
3. ✅ **Invalid module**: Exit code 1, shows available modules, suggests `--list`
4. ✅ **Invalid config YAML**: Exit code 1, shows file path, error details, suggests checking YAML syntax
5. ✅ **Config validation error**: Exit code 1, shows which field is missing, provides specific guidance
6. ✅ **Successful execution**: Exit code 0, works correctly with dry-run and normal execution
7. ✅ **List flag**: Exit code 0, displays profiles and modules correctly
8. ✅ **Panic recovery**: Implemented in both `runCommand()` and `main()`
9. ✅ **All errors use log.Error()**: Verified in all error paths
10. ✅ **Actionable error messages**: All errors provide helpful suggestions and available options

