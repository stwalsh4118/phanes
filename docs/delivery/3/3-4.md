# 3-4 Implement swap module

[Back to task list](./tasks.md)

## Description

Implement the swap module (`internal/modules/swap/swap.go`) that creates a swap file, configures it in `/etc/fstab` for persistence, and sets swappiness. This helps servers handle memory pressure gracefully.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 00:00:00 | Created | N/A | Proposed | Task file created | sean |

## Requirements

1. Implement `module.Module` interface:
   - `Name() string` - Returns "swap"
   - `Description() string` - Returns "Creates and configures swap file"
   - `IsInstalled() (bool, error)` - Checks if swap is configured
   - `Install(cfg *config.Config) error` - Creates swap file and configures it

2. Check if swap already exists:
   - Use `swapon --show` or read `/proc/swaps` to check for active swap
   - Check if swap file exists at expected location (`/swapfile` or configurable)
   - Check if `/etc/fstab` contains swap entry

3. Create swap file if needed:
   - Read swap size from `cfg.Swap.Size` (default: "2G", format: "1G", "512M", etc.)
   - Parse size string to bytes
   - Use `fallocate -l <size> /swapfile` (preferred) or `dd if=/dev/zero of=/swapfile bs=1M count=<size>`
   - Set permissions 600: `chmod 600 /swapfile`
   - Format as swap: `mkswap /swapfile`
   - Enable swap: `swapon /swapfile`
   - Show progress for large swap file creation (log progress messages)

4. Configure `/etc/fstab` for persistence:
   - Check if swap entry already exists in `/etc/fstab`
   - Add entry if not present: `/swapfile none swap sw 0 0`
   - Verify fstab syntax is correct

5. Set swappiness:
   - Set swappiness value (default: 10, reasonable for servers)
   - Use `sysctl vm.swappiness=10`
   - Make persistent: add to `/etc/sysctl.conf` or `/etc/sysctl.d/99-swappiness.conf`

6. Respect swap enabled flag:
   - Check `cfg.Swap.Enabled` (default: true)
   - If disabled, skip swap creation but still check/configure if swap exists

7. Idempotency:
   - `IsInstalled()` should check:
     - Swap is active (from `swapon --show`)
     - Swap file exists
     - `/etc/fstab` contains swap entry
     - Swappiness is set correctly
   - Return `true` if all checks pass, `false` otherwise
   - Return error if checks fail

8. Error handling:
   - Handle swap file creation errors (disk space, permissions)
   - Handle fstab write errors
   - Handle swappiness setting errors
   - Log errors using `log.Error()`
   - Return descriptive errors

9. Dry-run support:
   - Check dry-run mode from logging package
   - In dry-run mode, log what would be done but don't execute commands or create files
   - Still check current swap status

10. Logging:
    - Use `log.Info()` for progress messages (especially for large swap file creation)
    - Use `log.Success()` when operations complete
    - Use `log.Skip()` when module is already installed or swap is disabled
    - Show swap size being created

## Implementation Plan

1. Create `internal/modules/swap/` directory
2. Create `swap.go` with package declaration
3. Import required packages:
   - `github.com/stwalsh4118/phanes/internal/module`
   - `github.com/stwalsh4118/phanes/internal/config`
   - `github.com/stwalsh4118/phanes/internal/exec`
   - `github.com/stwalsh4118/phanes/internal/log`
   - `os` (for file operations)
   - `strings` (for string operations)
   - `strconv` (for parsing size strings)
   - `bufio` (for reading fstab)
   - `io` (for file operations)

4. Define `SwapModule` struct:
   ```go
   type SwapModule struct{}
   ```

5. Define constants:
   - Default swap file path: `/swapfile`
   - Default swappiness: `10`

6. Implement `Name()` method:
   - Return "swap"

7. Implement `Description()` method:
   - Return "Creates and configures swap file"

8. Implement helper function `parseSwapSize(sizeStr string) (int64, error)`:
   - Parse size string (e.g., "2G", "512M", "1G")
   - Convert to bytes
   - Return size in bytes and error

9. Implement helper function `swapExists() (bool, error)`:
   - Run `swapon --show` or read `/proc/swaps`
   - Check if swap is active
   - Return true if swap exists, false otherwise

10. Implement helper function `swapFileExists(path string) (bool, error)`:
    - Use `exec.FileExists()` or `os.Stat()` to check if file exists
    - Return true if exists, false otherwise

11. Implement helper function `fstabContainsSwap(swapPath string) (bool, error)`:
    - Read `/etc/fstab`
    - Check if swap entry exists for the swap file path
    - Return true if found, false otherwise

12. Implement helper function `swappinessIsSet(value int) (bool, error)`:
    - Read `vm.swappiness` from `sysctl vm.swappiness` or `/proc/sys/vm/swappiness`
    - Compare with expected value
    - Return true if matches, false otherwise

13. Implement `IsInstalled()` method:
    - Check if swap is enabled in config (`cfg.Swap.Enabled`)
    - If disabled, return `true` (nothing to install)
    - Check if swap exists using `swapExists()`
    - Check if swap file exists using `swapFileExists()`
    - Check if fstab contains swap entry using `fstabContainsSwap()`
    - Check if swappiness is set using `swappinessIsSet()`
    - Return `true` if all checks pass, `false` otherwise
    - Return error if checks fail

14. Implement `Install()` method:
    - Check if swap is enabled (`cfg.Swap.Enabled`)
    - If disabled, log skip message and return nil
    - Check dry-run mode
    - Parse swap size from `cfg.Swap.Size`
    - Check if swap already exists:
      - If exists, verify configuration (fstab, swappiness)
      - If not exists, create swap file:
        - Log progress: "Creating swap file of size <size>..."
        - Use `fallocate -l <size> /swapfile` (preferred) or `dd` as fallback
        - Set permissions: `exec.Run("chmod", "600", "/swapfile")`
        - Format swap: `exec.Run("mkswap", "/swapfile")`
        - Enable swap: `exec.Run("swapon", "/swapfile")`
        - Log progress updates for large files
    - Configure fstab:
      - Check if entry exists using `fstabContainsSwap()`
      - If not exists, append entry: `/swapfile none swap sw 0 0`
      - Read fstab, append line, write back
    - Set swappiness:
      - Set runtime value: `exec.Run("sysctl", "vm.swappiness=10")`
      - Make persistent: write to `/etc/sysctl.d/99-swappiness.conf` or append to `/etc/sysctl.conf`
    - Log success message
    - Return error if any step fails

15. Create unit tests in `swap_test.go`:
    - Test `Name()` and `Description()`
    - Test `parseSwapSize()` with various formats ("2G", "512M", "1G")
    - Test `swapExists()` with mocked exec calls
    - Test `swapFileExists()` with mocked file checks
    - Test `fstabContainsSwap()` with mocked fstab reads
    - Test `swappinessIsSet()` with mocked sysctl calls
    - Test `IsInstalled()` with various scenarios
    - Test `Install()` with mocked exec calls
    - Test swap disabled scenario
    - Test dry-run mode
    - Test error handling

## Verification

1. Module implements `module.Module` interface correctly
2. `Name()` returns "swap"
3. `Description()` returns correct description
4. `IsInstalled()` correctly checks swap, fstab, and swappiness
5. `Install()` creates swap file, configures fstab, and sets swappiness
6. Swap size parsing works correctly (handles "2G", "512M", etc.)
7. Progress logging works for large swap files
8. Module respects `cfg.Swap.Enabled` flag
9. Module is idempotent (can run multiple times safely)
10. Error handling works correctly
11. Dry-run mode is respected
12. All logging is appropriate
13. Unit tests pass

## Test Plan

1. **Name and Description**: Verify `Name()` and `Description()` return correct values
2. **Swap Size Parsing**: Test `parseSwapSize()` with "2G", "512M", "1G", invalid formats
3. **Swap Exists Check**: Mock `swapon --show`, verify swap detection
4. **Swap File Exists Check**: Mock file system, verify file existence check
5. **Fstab Check**: Mock fstab read, verify swap entry detection
6. **Swappiness Check**: Mock sysctl read, verify swappiness check
7. **IsInstalled - Fully configured**: Mock all checks to return true, verify returns `true`
8. **IsInstalled - Not configured**: Mock checks to return false, verify returns `false`
9. **IsInstalled - Swap disabled**: Test with `Enabled=false`, verify returns `true`
10. **Install - New swap**: Mock exec calls, verify swap file creation, fstab config, swappiness
11. **Install - Swap exists**: Mock swap exists, verify only fstab and swappiness are configured
12. **Install - Swap disabled**: Test with `Enabled=false`, verify skip message
13. **Install - Large swap file**: Test progress logging for large swap creation
14. **Dry-run mode**: Verify commands are logged but not executed in dry-run mode
15. **Idempotency**: Run `Install()` twice, verify second run is skipped (IsInstalled returns true)
16. **Error handling**: Test disk space errors, permission errors, fstab write errors

## Files Modified

- `internal/modules/swap/swap.go` (new) - Swap module implementation
- `internal/modules/swap/swap_test.go` (new) - Unit tests for swap module
- `docs/api-specs/infrastructure/infrastructure-api.md` (updated) - Add swap module API documentation

