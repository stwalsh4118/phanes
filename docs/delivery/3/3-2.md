# 3-2 Implement user module

[Back to task list](./tasks.md)

## Description

Implement the user module (`internal/modules/user/user.go`) that creates a non-root user, sets up SSH key access, and configures passwordless sudo. This module ensures secure user access without root privileges.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 00:00:00 | Created | N/A | Proposed | Task file created | sean |

## Requirements

1. Implement `module.Module` interface:
   - `Name() string` - Returns "user"
   - `Description() string` - Returns "Creates user and sets up SSH keys"
   - `IsInstalled() (bool, error)` - Checks if user exists and SSH key is configured
   - `Install(cfg *config.Config) error` - Creates user, sets up SSH keys, and configures sudo

2. Create user if doesn't exist:
   - Use `useradd` or `adduser` command
   - Read username from `cfg.User.Username` (required field)
   - Create user with home directory: `useradd -m -s /bin/bash <username>`
   - Handle case where user already exists (should not error)

3. Set up SSH directory:
   - Create `~/.ssh` directory with permissions 700
   - Use `exec.FileExists()` to check if directory exists
   - Use `exec.Run()` with `mkdir -p` and `chmod` if needed
   - Or use `os.MkdirAll()` and `os.Chmod()` directly

4. Add SSH public key:
   - Read SSH public key from `cfg.User.SSHPublicKey` (required field)
   - Verify SSH key format (basic validation: starts with ssh-rsa, ssh-ed25519, etc.)
   - Append to `~/.ssh/authorized_keys` file
   - Set permissions 600 on `authorized_keys`
   - Handle case where key already exists (deduplicate or skip)

5. Configure passwordless sudo:
   - Create sudoers file: `/etc/sudoers.d/<username>`
   - Content: `<username> ALL=(ALL) NOPASSWD:ALL`
   - Use `visudo -c` to validate sudoers file before applying
   - Set correct permissions (0440) on sudoers file

6. Idempotency:
   - `IsInstalled()` should check:
     - User exists (check `/etc/passwd` or use `id` command)
     - `~/.ssh/authorized_keys` exists and contains the SSH key
     - Sudoers file exists and is configured correctly
   - Return `true` if all checks pass, `false` otherwise
   - Return error if checks fail

7. Error handling:
   - Validate username is not empty
   - Validate SSH public key format
   - Handle permission errors gracefully
   - Log errors using `log.Error()`
   - Return descriptive errors

8. Dry-run support:
   - Check dry-run mode from logging package
   - In dry-run mode, log what would be done but don't execute commands or create files

9. Logging:
   - Use `log.Info()` for progress messages
   - Use `log.Success()` when operations complete
   - Use `log.Skip()` when module is already installed
   - Warn if SSH key format is invalid

## Implementation Plan

1. Create `internal/modules/user/` directory
2. Create `user.go` with package declaration
3. Import required packages:
   - `github.com/stwalsh4118/phanes/internal/module`
   - `github.com/stwalsh4118/phanes/internal/config`
   - `github.com/stwalsh4118/phanes/internal/exec`
   - `github.com/stwalsh4118/phanes/internal/log`
   - `os` (for file operations)
   - `os/user` (for user lookup)
   - `strings` (for string operations)
   - `path/filepath` (for path operations)

4. Define `UserModule` struct:
   ```go
   type UserModule struct{}
   ```

5. Implement `Name()` method:
   - Return "user"

6. Implement `Description()` method:
   - Return "Creates user and sets up SSH keys"

7. Implement helper function `validateSSHKey(key string) error`:
   - Check if key starts with valid SSH key types: "ssh-rsa", "ssh-ed25519", "ecdsa-sha2-", "ssh-dss"
   - Return error if format is invalid

8. Implement helper function `userExists(username string) (bool, error)`:
   - Use `user.Lookup(username)` or `exec.RunWithOutput("id", username)`
   - Return true if user exists, false otherwise

9. Implement helper function `sshKeyExists(authorizedKeysPath string, key string) (bool, error)`:
   - Read `authorized_keys` file
   - Check if key (or key fingerprint) already exists
   - Return true if found, false otherwise

10. Implement `IsInstalled()` method:
    - Check if user exists using `userExists()`
    - Check if `~/.ssh/authorized_keys` exists
    - Check if SSH key is in authorized_keys using `sshKeyExists()`
    - Check if sudoers file exists and is correct
    - Return `true` if all checks pass, `false` otherwise
    - Return error if checks fail

11. Implement `Install()` method:
    - Validate username and SSH key format
    - Check dry-run mode
    - Create user if doesn't exist:
      - Use `exec.Run("useradd", "-m", "-s", "/bin/bash", cfg.User.Username)`
      - Handle "user already exists" error gracefully
    - Create `~/.ssh` directory:
      - Use `os.MkdirAll()` with permissions 0700
      - Or use `exec.Run("mkdir", "-p", sshDir)` and `exec.Run("chmod", "700", sshDir)`
    - Add SSH key to authorized_keys:
      - Read existing file (if exists)
      - Append key if not already present
      - Write file with permissions 0600
      - Use `exec.WriteFile()` or `os.WriteFile()`
    - Configure sudoers:
      - Create sudoers content: `<username> ALL=(ALL) NOPASSWD:ALL`
      - Write to `/etc/sudoers.d/<username>`
      - Validate with `exec.Run("visudo", "-c", "-f", sudoersPath)`
      - Set permissions 0440
    - Log success message
    - Return error if any step fails

12. Create unit tests in `user_test.go`:
    - Test `Name()` and `Description()`
    - Test `validateSSHKey()` with valid/invalid keys
    - Test `userExists()` with mocked exec calls
    - Test `sshKeyExists()` with mocked file reads
    - Test `IsInstalled()` with various scenarios
    - Test `Install()` with mocked exec calls
    - Test dry-run mode
    - Test error handling

## Verification

1. Module implements `module.Module` interface correctly
2. `Name()` returns "user"
3. `Description()` returns correct description
4. `IsInstalled()` correctly checks user, SSH key, and sudoers
5. `Install()` creates user, sets up SSH keys, and configures sudo
6. SSH key format validation works correctly
7. Module is idempotent (can run multiple times safely)
8. Error handling works correctly
9. Dry-run mode is respected
10. All logging is appropriate
11. Unit tests pass

## Test Plan

1. **Name and Description**: Verify `Name()` and `Description()` return correct values
2. **SSH Key Validation**: Test `validateSSHKey()` with valid keys (ssh-rsa, ssh-ed25519) and invalid keys
3. **User Exists Check**: Mock `user.Lookup()` or `id` command, verify user existence check
4. **SSH Key Exists Check**: Mock file read, verify key detection in authorized_keys
5. **IsInstalled - Fully configured**: Mock all checks to return true, verify returns `true`
6. **IsInstalled - Not configured**: Mock checks to return false, verify returns `false`
7. **Install - New user**: Mock exec calls, verify user creation, SSH setup, and sudoers configuration
8. **Install - Existing user**: Mock user exists, verify only SSH and sudoers are configured
9. **Install - SSH key exists**: Mock key already in file, verify no duplicate added
10. **Install - Invalid SSH key**: Test with invalid key format, verify error
11. **Dry-run mode**: Verify commands are logged but not executed in dry-run mode
12. **Idempotency**: Run `Install()` twice, verify second run is skipped (IsInstalled returns true)

## Files Modified

- `internal/modules/user/user.go` (new) - User module implementation
- `internal/modules/user/user_test.go` (new) - Unit tests for user module
- `docs/api-specs/infrastructure/infrastructure-api.md` (updated) - Add user module API documentation

