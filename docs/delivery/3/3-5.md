# 3-5 Implement updates module

[Back to task list](./tasks.md)

## Description

Implement the updates module (`internal/modules/updates/updates.go`) that installs and configures `unattended-upgrades` for automatic security updates. This ensures servers stay patched with security updates automatically.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 00:00:00 | Created | N/A | Proposed | Task file created | sean |

## Requirements

1. Implement `module.Module` interface:
   - `Name() string` - Returns "updates"
   - `Description() string` - Returns "Configures automatic security updates"
   - `IsInstalled() (bool, error)` - Checks if unattended-upgrades is installed and configured
   - `Install(cfg *config.Config) error` - Installs and configures unattended-upgrades

2. Install unattended-upgrades:
   - Install package: `apt-get install -y unattended-upgrades`
   - Verify installation succeeded

3. Configure automatic security updates:
   - Configure `/etc/apt/apt.conf.d/50unattended-upgrades`:
     - Enable automatic updates for security updates
     - Configure update origins (security, updates)
     - Set auto-remove unused dependencies
     - Configure email notifications (optional, can be disabled)
   - Configure `/etc/apt/apt.conf.d/20auto-upgrades`:
     - Enable automatic updates: `APT::Periodic::Update-Package-Lists "1"`
     - Enable automatic upgrade: `APT::Periodic::Unattended-Upgrade "1"`
     - Set update interval (daily)
     - Set upgrade interval (daily)

4. Automatic reboot configuration (optional):
   - Per PRD open question: default off
   - Can be configured in `/etc/apt/apt.conf.d/50unattended-upgrades`
   - Set `Unattended-Upgrade::Automatic-Reboot "false"` by default
   - Can be enabled via config if needed in future

5. Idempotency:
   - `IsInstalled()` should check:
     - unattended-upgrades package is installed
     - Configuration files exist and are correctly configured
     - Automatic updates are enabled
   - Return `true` if all checks pass, `false` otherwise
   - Return error if checks fail

6. Error handling:
   - Handle package installation errors
   - Handle configuration file write errors
   - Log errors using `log.Error()`
   - Return descriptive errors

7. Dry-run support:
   - Check dry-run mode from logging package
   - In dry-run mode, log what would be done but don't execute commands or write files

8. Logging:
   - Use `log.Info()` for progress messages
   - Use `log.Success()` when operations complete
   - Use `log.Skip()` when module is already installed
   - Inform user about automatic reboot setting (if enabled)

## Implementation Plan

1. Create `internal/modules/updates/` directory
2. Create `updates.go` with package declaration
3. Import required packages:
   - `github.com/stwalsh4118/phanes/internal/module`
   - `github.com/stwalsh4118/phanes/internal/config`
   - `github.com/stwalsh4118/phanes/internal/exec`
   - `github.com/stwalsh4118/phanes/internal/log`
   - `os` (for file operations)
   - `strings` (for string operations)

4. Define `UpdatesModule` struct:
   ```go
   type UpdatesModule struct{}
   ```

5. Define configuration file templates/content:
   - `50unattended-upgrades` content (as string constant or template)
   - `20auto-upgrades` content (as string constant)

6. Implement `Name()` method:
   - Return "updates"

7. Implement `Description()` method:
   - Return "Configures automatic security updates"

8. Implement helper function `unattendedUpgradesInstalled() (bool, error)`:
   - Check if package is installed: `dpkg -l unattended-upgrades` or `which unattended-upgrades`
   - Return true if installed, false otherwise

9. Implement helper function `unattendedUpgradesConfigured() (bool, error)`:
   - Check if `/etc/apt/apt.conf.d/50unattended-upgrades` exists and contains expected config
   - Check if `/etc/apt/apt.conf.d/20auto-upgrades` exists and contains expected config
   - Return true if both configured, false otherwise

10. Implement helper function `generate50UnattendedUpgrades() string`:
    - Return configuration content for 50unattended-upgrades
    - Include security update origins
    - Set auto-remove
    - Set automatic reboot to false (per PRD)

11. Implement helper function `generate20AutoUpgrades() string`:
    - Return configuration content for 20auto-upgrades
    - Enable Update-Package-Lists: "1"
    - Enable Unattended-Upgrade: "1"
    - Set intervals to daily

12. Implement `IsInstalled()` method:
    - Check if unattended-upgrades is installed using `unattendedUpgradesInstalled()`
    - Check if configuration files are correct using `unattendedUpgradesConfigured()`
    - Return `true` if all checks pass, `false` otherwise
    - Return error if checks fail

13. Implement `Install()` method:
    - Check dry-run mode
    - Install unattended-upgrades:
      - Check if already installed using `unattendedUpgradesInstalled()`
      - If not installed, run: `exec.Run("apt-get", "install", "-y", "unattended-upgrades")`
    - Configure 50unattended-upgrades:
      - Generate config content using `generate50UnattendedUpgrades()`
      - Write to `/etc/apt/apt.conf.d/50unattended-upgrades` using `exec.WriteFile()`
    - Configure 20auto-upgrades:
      - Generate config content using `generate20AutoUpgrades()`
      - Write to `/etc/apt/apt.conf.d/20auto-upgrades` using `exec.WriteFile()`
    - Verify configuration:
      - Run `unattended-upgrades --dry-run --debug` to test configuration (optional)
    - Log success message
    - Return error if any step fails

14. Create unit tests in `updates_test.go`:
    - Test `Name()` and `Description()`
    - Test `unattendedUpgradesInstalled()` with mocked exec calls
    - Test `unattendedUpgradesConfigured()` with mocked file reads
    - Test `generate50UnattendedUpgrades()` returns correct config
    - Test `generate20AutoUpgrades()` returns correct config
    - Test `IsInstalled()` with various scenarios
    - Test `Install()` with mocked exec calls
    - Test dry-run mode
    - Test error handling

## Verification

1. Module implements `module.Module` interface correctly
2. `Name()` returns "updates"
3. `Description()` returns correct description
4. `IsInstalled()` correctly checks package installation and configuration
5. `Install()` installs unattended-upgrades and configures both files
6. Configuration files contain correct settings
7. Automatic reboot is disabled by default (per PRD)
8. Module is idempotent (can run multiple times safely)
9. Error handling works correctly
10. Dry-run mode is respected
11. All logging is appropriate
12. Unit tests pass

## Test Plan

1. **Name and Description**: Verify `Name()` and `Description()` return correct values
2. **Package Installed Check**: Mock `dpkg -l` or `which`, verify package detection
3. **Configuration Check**: Mock file reads, verify config detection
4. **Config Generation**: Test `generate50UnattendedUpgrades()` and `generate20AutoUpgrades()` return correct content
5. **IsInstalled - Fully configured**: Mock all checks to return true, verify returns `true`
6. **IsInstalled - Not configured**: Mock checks to return false, verify returns `false`
7. **Install - New installation**: Mock exec calls, verify package installation and config file creation
8. **Install - Already installed**: Mock package installed, verify only config files are created/updated
9. **Install - Config files exist**: Mock config files exist, verify they are updated if needed
10. **Dry-run mode**: Verify commands are logged but not executed in dry-run mode
11. **Idempotency**: Run `Install()` twice, verify second run is skipped (IsInstalled returns true)
12. **Error handling**: Test package installation errors, config file write errors
13. **Automatic reboot**: Verify config sets `Automatic-Reboot "false"` by default

## Files Modified

- `internal/modules/updates/updates.go` (new) - Updates module implementation
- `internal/modules/updates/updates_test.go` (new) - Unit tests for updates module
- `docs/api-specs/infrastructure/infrastructure-api.md` (updated) - Add updates module API documentation

