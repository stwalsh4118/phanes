# 5-1 Implement Nginx module

[Back to task list](./tasks.md)

## Description

Implement the Nginx module (`internal/modules/nginx/nginx.go`) that installs Nginx web server via apt, enables and starts the service, and verifies it is running and accessible on port 80. This provides HTTP/HTTPS serving capabilities for web applications.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 00:00:00 | Created | N/A | Proposed | Task file created | sean |
| 2025-01-27 16:00:00 | Status Update | Proposed | InProgress | Started implementation | sean |
| 2025-01-27 16:30:00 | Status Update | InProgress | Review | Implementation complete, all tests passing | sean |
| 2025-01-27 16:35:00 | Status Update | Review | Done | Task approved and completed | sean |

## Requirements

1. Implement `module.Module` interface:
   - `Name() string` - Returns "nginx"
   - `Description() string` - Returns "Installs and configures Nginx web server"
   - `IsInstalled() (bool, error)` - Checks if Nginx is installed and running
   - `Install(cfg *config.Config) error` - Installs and configures Nginx

2. Install Nginx via apt:
   - Update package list: `apt-get update`
   - Install nginx package: `apt-get install -y nginx`
   - Verify nginx is installed: `nginx -v`

3. Configure Nginx service:
   - Check if service is enabled: `systemctl is-enabled nginx`
   - Enable service if not enabled: `systemctl enable nginx`
   - Check if service is running: `systemctl is-active nginx`
   - Start service if not running: `systemctl start nginx`
   - Verify service is running: `systemctl is-active nginx`

4. Verify Nginx is accessible:
   - Check if Nginx is listening on port 80: `ss -tlnp | grep :80` or `netstat -tlnp | grep :80`
   - Log success message with access URL: `http://localhost`

5. Port conflict detection:
   - Before installation, check if port 80 is already in use
   - If port 80 is in use by another service, log a warning but proceed (user may have configured it)
   - Warn if port conflict detected: `log.Warn("Port 80 is already in use. Nginx may not be able to bind to this port.")`

6. Configuration flag:
   - Respect `cfg.Nginx.Enabled` flag
   - If `Enabled` is `false`, skip installation and log skip message
   - If `Enabled` is `true` (default), proceed with installation

7. Idempotency:
   - `IsInstalled()` should check:
     - Nginx is installed (`nginx -v` succeeds or binary exists)
     - Nginx service is running (`systemctl is-active nginx` returns "active")
     - Nginx is listening on port 80
   - Return `true` if all checks pass, `false` otherwise
   - Return error if checks fail

8. Error handling:
   - Handle apt update errors
   - Handle nginx installation errors
   - Handle service start/enable errors
   - Handle port accessibility check errors
   - Log errors using `log.Error()`
   - Return descriptive errors

9. Dry-run support:
   - Check dry-run mode from logging package
   - In dry-run mode, log what would be done but don't execute commands
   - Still check current Nginx installation status

10. Logging:
    - Use `log.Info()` for progress messages (especially during installation)
    - Use `log.Success()` when operations complete
    - Use `log.Skip()` when module is already installed or disabled
    - Use `log.Warn()` when port conflicts are detected
    - Show Nginx access URL after installation

## Implementation Plan

1. Create `internal/modules/nginx/` directory
2. Create `nginx.go` with package declaration
3. Import required packages:
   - `github.com/stwalsh4118/phanes/internal/module`
   - `github.com/stwalsh4118/phanes/internal/config`
   - `github.com/stwalsh4118/phanes/internal/exec`
   - `github.com/stwalsh4118/phanes/internal/log`
   - `fmt` (for string formatting)
   - `strings` (for string operations)

4. Define `NginxModule` struct:
   ```go
   type NginxModule struct{}
   ```

5. Define constants:
   - Nginx service name: `nginx`
   - Nginx default HTTP port: `80`
   - Nginx binary path: `/usr/sbin/nginx`

6. Implement `Name()` method:
   - Return "nginx"

7. Implement `Description()` method:
   - Return "Installs and configures Nginx web server"

8. Implement helper function `nginxInstalled() (bool, error)`:
   - Check if `nginx` binary exists: `/usr/sbin/nginx` or `which nginx`
   - Or run `nginx -v` and check if it succeeds
   - Or check if service exists: `systemctl list-unit-files | grep nginx.service`
   - Return true if installed, false otherwise

9. Implement helper function `nginxServiceRunning() (bool, error)`:
   - Run `systemctl is-active nginx` and check if it returns "active"
   - Return true if running, false otherwise

10. Implement helper function `nginxServiceEnabled() (bool, error)`:
    - Run `systemctl is-enabled nginx` and check if it returns "enabled" or "enabled-runtime"
    - Return true if enabled, false otherwise

11. Implement helper function `nginxPortAccessible() (bool, error)`:
    - Try `ss -tlnp` first (more modern), fallback to `netstat -tlnp`
    - Check if port 80 is in the output: `:80`
    - Return true if port is accessible, false otherwise
    - Return error if both commands fail

12. Implement helper function `port80InUse() (bool, error)`:
    - Check if port 80 is already in use by another service
    - Use same method as `nginxPortAccessible()` but check if it's NOT nginx
    - Return true if port is in use by another service, false otherwise

13. Implement `IsInstalled()` method:
    - Check if Nginx is installed using `nginxInstalled()`
    - Check if Nginx service is running using `nginxServiceRunning()`
    - Check if Nginx port is accessible using `nginxPortAccessible()`
    - Return `true` if all checks pass, `false` otherwise
    - Return error if checks fail

14. Implement `Install()` method:
    - Check dry-run mode
    - Check `cfg.Nginx.Enabled` flag:
      - If `false`, log skip message and return nil
      - If `true`, proceed with installation
    - Check if port 80 is in use by another service:
      - If yes, log warning about port conflict
    - Check if Nginx is already installed:
      - If installed, verify service is running and port is accessible
      - If not installed, proceed with installation
    - Install Nginx:
      - Update apt: `exec.Run("apt-get", "update")`
      - Install: `exec.Run("apt-get", "install", "-y", "nginx")`
      - Verify: `exec.Run("nginx", "-v")`
    - Configure Nginx service:
      - Check if enabled using `nginxServiceEnabled()`
      - If not enabled, enable: `exec.Run("systemctl", "enable", "nginx")`
      - Check if running using `nginxServiceRunning()`
      - If not running, start: `exec.Run("systemctl", "start", "nginx")`
      - Verify running: `exec.Run("systemctl", "is-active", "nginx")`
    - Verify Nginx is accessible:
      - Check port using `nginxPortAccessible()`
      - Log success message with access URL: `http://localhost`
    - Log success message
    - Return error if any step fails

15. Create unit tests in `nginx_test.go`:
    - Test `Name()` and `Description()`
    - Test `nginxInstalled()` with mocked file/exec checks
    - Test `nginxServiceRunning()` with mocked exec calls
    - Test `nginxServiceEnabled()` with mocked exec calls
    - Test `nginxPortAccessible()` with mocked exec calls
    - Test `port80InUse()` with mocked exec calls
    - Test `IsInstalled()` with various scenarios
    - Test `Install()` with mocked exec calls
    - Test `Nginx.Enabled=false` scenario
    - Test port conflict detection
    - Test dry-run mode
    - Test error handling

## Verification

1. Module implements `module.Module` interface correctly
2. `Name()` returns "nginx"
3. `Description()` returns correct description
4. `IsInstalled()` correctly checks Nginx installation, service status, and port accessibility
5. `Install()` installs Nginx via apt, enables and starts service, and verifies accessibility
6. Nginx service is enabled and started correctly
7. Nginx port accessibility is verified
8. Port conflict detection works correctly
9. `cfg.Nginx.Enabled` flag is respected
10. Module is idempotent (can run multiple times safely)
11. Error handling works correctly
12. Dry-run mode is respected
13. All logging is appropriate
14. Unit tests pass

## Test Plan

1. **Name and Description**: Verify `Name()` and `Description()` return correct values
2. **Nginx Installed Check**: Mock file/exec checks, verify installation detection
3. **Nginx Service Check**: Mock `systemctl is-active`, verify service status check
4. **Nginx Service Enabled Check**: Mock `systemctl is-enabled`, verify enabled check
5. **Nginx Port Check**: Mock `ss`/`netstat`, verify port accessibility check
6. **Port Conflict Detection**: Mock port 80 in use by another service, verify warning is logged
7. **IsInstalled - Fully configured**: Mock all checks to return true, verify returns `true`
8. **IsInstalled - Not configured**: Mock checks to return false, verify returns `false`
9. **Install - Full setup**: Mock exec calls, verify apt update, nginx installation, service enable/start, port check
10. **Install - Nginx already installed**: Mock Nginx installed, verify only service and port are checked
11. **Install - Service not enabled**: Mock service not enabled, verify enable command is executed
12. **Install - Service not running**: Mock service not running, verify start command is executed
13. **Install - Nginx disabled**: Test with `Nginx.Enabled=false`, verify skip message
14. **Install - Port conflict**: Mock port 80 in use, verify warning is logged but installation proceeds
15. **Dry-run mode**: Verify commands are logged but not executed in dry-run mode
16. **Idempotency**: Run `Install()` twice, verify second run is skipped (IsInstalled returns true)
17. **Error handling**: Test apt update errors, installation errors, service start errors, port check errors

## Files Modified

- `internal/modules/nginx/nginx.go` (new) - Nginx module implementation
- `internal/modules/nginx/nginx_test.go` (new) - Unit tests for Nginx module
- `main.go` (updated) - Register NginxModule in registerAllModules()
- `docs/api-specs/infrastructure/infrastructure-api.md` (updated) - Add Nginx module API documentation


