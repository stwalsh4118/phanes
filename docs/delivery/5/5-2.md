# 5-2 Implement Caddy module

[Back to task list](./tasks.md)

## Description

Implement the Caddy module (`internal/modules/caddy/caddy.go`) that installs Caddy web server via apt repository, creates basic configuration directory structure, enables and starts the service, and verifies it is running and accessible on port 80. Caddy provides automatic HTTPS certificate management.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 00:00:00 | Created | N/A | Proposed | Task file created | sean |

## Requirements

1. Implement `module.Module` interface:
   - `Name() string` - Returns "caddy"
   - `Description() string` - Returns "Installs and configures Caddy web server with automatic HTTPS"
   - `IsInstalled() (bool, error)` - Checks if Caddy is installed and running
   - `Install(cfg *config.Config) error` - Installs and configures Caddy

2. Add Caddy's official apt repository:
   - Install prerequisites: `apt-get update` and `apt-get install -y debian-keyring debian-archive-keyring apt-transport-https`
   - Add Caddy's GPG key: `curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg`
   - Add Caddy repository: `curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee /etc/apt/sources.list.d/caddy-stable.list`
   - Update apt package list: `apt-get update`

3. Install Caddy via apt:
   - Install caddy package: `apt-get install -y caddy`
   - Verify caddy is installed: `caddy version`

4. Create Caddy configuration directory:
   - Create `/etc/caddy/` directory if it doesn't exist: `mkdir -p /etc/caddy`
   - Create basic Caddyfile if it doesn't exist (minimal default for localhost)
   - Default Caddyfile content:
     ```
     localhost {
         respond "Caddy is running!"
     }
     ```

5. Configure Caddy service:
   - Check if service is enabled: `systemctl is-enabled caddy`
   - Enable service if not enabled: `systemctl enable caddy`
   - Check if service is running: `systemctl is-active caddy`
   - Start service if not running: `systemctl start caddy`
   - Verify service is running: `systemctl is-active caddy`

6. Verify Caddy is accessible:
   - Check if Caddy is listening on port 80: `ss -tlnp | grep :80` or `netstat -tlnp | grep :80`
   - Log success message with access URL: `http://localhost`
   - Log message about automatic HTTPS capability

7. Port conflict detection:
   - Before installation, check if port 80 is already in use
   - If port 80 is in use by another service, log a warning but proceed (user may have configured it)
   - Warn if port conflict detected: `log.Warn("Port 80 is already in use. Caddy may not be able to bind to this port.")`

8. Configuration flag:
   - Respect `cfg.Caddy.Enabled` flag
   - If `Enabled` is `false`, skip installation and log skip message
   - If `Enabled` is `true` (default), proceed with installation

9. Idempotency:
   - `IsInstalled()` should check:
     - Caddy is installed (`caddy version` succeeds or binary exists)
     - Caddy service is running (`systemctl is-active caddy` returns "active")
     - Caddy is listening on port 80
   - Return `true` if all checks pass, `false` otherwise
   - Return error if checks fail

10. Error handling:
    - Handle GPG key download errors
    - Handle repository addition errors
    - Handle apt update errors
    - Handle caddy installation errors
    - Handle service start/enable errors
    - Handle port accessibility check errors
    - Handle directory creation errors
    - Log errors using `log.Error()`
    - Return descriptive errors

11. Dry-run support:
    - Check dry-run mode from logging package
    - In dry-run mode, log what would be done but don't execute commands
    - Still check current Caddy installation status

12. Logging:
    - Use `log.Info()` for progress messages (especially during installation)
    - Use `log.Success()` when operations complete
    - Use `log.Skip()` when module is already installed or disabled
    - Use `log.Warn()` when port conflicts are detected
    - Show Caddy access URL after installation
    - Mention automatic HTTPS capability: "Caddy provides automatic HTTPS certificates via Let's Encrypt"

## Implementation Plan

1. Create `internal/modules/caddy/` directory
2. Create `caddy.go` with package declaration
3. Import required packages:
   - `github.com/stwalsh4118/phanes/internal/module`
   - `github.com/stwalsh4118/phanes/internal/config`
   - `github.com/stwalsh4118/phanes/internal/exec`
   - `github.com/stwalsh4118/phanes/internal/log`
   - `fmt` (for string formatting)
   - `os` (for file operations)
   - `strings` (for string operations)

4. Define `CaddyModule` struct:
   ```go
   type CaddyModule struct{}
   ```

5. Define constants:
   - Caddy service name: `caddy`
   - Caddy default HTTP port: `80`
   - Caddy binary path: `/usr/bin/caddy`
   - Caddy config directory: `/etc/caddy`
   - Caddyfile path: `/etc/caddy/Caddyfile`
   - Caddy GPG key URL: `https://dl.cloudsmith.io/public/caddy/stable/gpg.key`
   - Caddy repository URL: `https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt`
   - Caddy GPG keyring path: `/usr/share/keyrings/caddy-stable-archive-keyring.gpg`
   - Caddy apt sources path: `/etc/apt/sources.list.d/caddy-stable.list`
   - Default Caddyfile content: `localhost { respond "Caddy is running!" }`

6. Implement `Name()` method:
   - Return "caddy"

7. Implement `Description()` method:
   - Return "Installs and configures Caddy web server with automatic HTTPS"

8. Implement helper function `caddyInstalled() (bool, error)`:
   - Check if `caddy` binary exists: `/usr/bin/caddy` or `which caddy`
   - Or run `caddy version` and check if it succeeds
   - Or check if service exists: `systemctl list-unit-files | grep caddy.service`
   - Return true if installed, false otherwise

9. Implement helper function `caddyServiceRunning() (bool, error)`:
   - Run `systemctl is-active caddy` and check if it returns "active"
   - Return true if running, false otherwise

10. Implement helper function `caddyServiceEnabled() (bool, error)`:
    - Run `systemctl is-enabled caddy` and check if it returns "enabled" or "enabled-runtime"
    - Return true if enabled, false otherwise

11. Implement helper function `caddyPortAccessible() (bool, error)`:
    - Try `ss -tlnp` first (more modern), fallback to `netstat -tlnp`
    - Check if port 80 is in the output: `:80`
    - Return true if port is accessible, false otherwise
    - Return error if both commands fail

12. Implement helper function `port80InUse() (bool, error)`:
    - Check if port 80 is already in use by another service
    - Use same method as `caddyPortAccessible()` but check if it's NOT caddy
    - Return true if port is in use by another service, false otherwise

13. Implement helper function `caddyfileExists() (bool, error)`:
    - Check if `/etc/caddy/Caddyfile` exists
    - Return true if exists, false otherwise

14. Implement helper function `createDefaultCaddyfile() error`:
    - Create `/etc/caddy/` directory if it doesn't exist: `os.MkdirAll("/etc/caddy", 0755)`
    - Write default Caddyfile content to `/etc/caddy/Caddyfile`
    - Return error if file operations fail

15. Implement `IsInstalled()` method:
    - Check if Caddy is installed using `caddyInstalled()`
    - Check if Caddy service is running using `caddyServiceRunning()`
    - Check if Caddy port is accessible using `caddyPortAccessible()`
    - Return `true` if all checks pass, `false` otherwise
    - Return error if checks fail

16. Implement `Install()` method:
    - Check dry-run mode
    - Check `cfg.Caddy.Enabled` flag:
      - If `false`, log skip message and return nil
      - If `true`, proceed with installation
    - Check if port 80 is in use by another service:
      - If yes, log warning about port conflict
    - Check if Caddy is already installed:
      - If installed, verify service is running and port is accessible
      - If not installed, proceed with installation
    - Add Caddy's apt repository:
      - Install prerequisites: `exec.Run("apt-get", "update")` and `exec.Run("apt-get", "install", "-y", "debian-keyring", "debian-archive-keyring", "apt-transport-https")`
      - Download GPG key: `exec.Run("curl", "-1sLf", caddyGPGKeyURL)`
      - Add GPG key: `exec.Run("gpg", "--dearmor", "-o", caddyGPGKeyringPath)`
      - Add repository: `exec.Run("curl", "-1sLf", caddyRepositoryURL)`
      - Update apt: `exec.Run("apt-get", "update")`
    - Install Caddy:
      - Install: `exec.Run("apt-get", "install", "-y", "caddy")`
      - Verify: `exec.Run("caddy", "version")`
    - Create Caddy configuration:
      - Check if `/etc/caddy/` directory exists, create if not: `os.MkdirAll("/etc/caddy", 0755)`
      - Check if Caddyfile exists using `caddyfileExists()`
      - If Caddyfile doesn't exist, create default using `createDefaultCaddyfile()`
    - Configure Caddy service:
      - Check if enabled using `caddyServiceEnabled()`
      - If not enabled, enable: `exec.Run("systemctl", "enable", "caddy")`
      - Check if running using `caddyServiceRunning()`
      - If not running, start: `exec.Run("systemctl", "start", "caddy")`
      - Verify running: `exec.Run("systemctl", "is-active", "caddy")`
    - Verify Caddy is accessible:
      - Check port using `caddyPortAccessible()`
      - Log success message with access URL: `http://localhost`
      - Log message about automatic HTTPS capability
    - Log success message
    - Return error if any step fails

17. Create unit tests in `caddy_test.go`:
    - Test `Name()` and `Description()`
    - Test `caddyInstalled()` with mocked file/exec checks
    - Test `caddyServiceRunning()` with mocked exec calls
    - Test `caddyServiceEnabled()` with mocked exec calls
    - Test `caddyPortAccessible()` with mocked exec calls
    - Test `port80InUse()` with mocked exec calls
    - Test `caddyfileExists()` with mocked file checks
    - Test `createDefaultCaddyfile()` with mocked file operations
    - Test `IsInstalled()` with various scenarios
    - Test `Install()` with mocked exec calls
    - Test `Caddy.Enabled=false` scenario
    - Test port conflict detection
    - Test Caddyfile creation
    - Test dry-run mode
    - Test error handling

## Verification

1. Module implements `module.Module` interface correctly
2. `Name()` returns "caddy"
3. `Description()` returns correct description
4. `IsInstalled()` correctly checks Caddy installation, service status, and port accessibility
5. `Install()` adds GPG key, adds repository, installs Caddy, creates config directory, enables and starts service, and verifies accessibility
6. Caddy service is enabled and started correctly
7. Caddy port accessibility is verified
8. Default Caddyfile is created if it doesn't exist
9. Port conflict detection works correctly
10. `cfg.Caddy.Enabled` flag is respected
11. Module is idempotent (can run multiple times safely)
12. Error handling works correctly
13. Dry-run mode is respected
14. All logging is appropriate
15. Unit tests pass

## Test Plan

1. **Name and Description**: Verify `Name()` and `Description()` return correct values
2. **Caddy Installed Check**: Mock file/exec checks, verify installation detection
3. **Caddy Service Check**: Mock `systemctl is-active`, verify service status check
4. **Caddy Service Enabled Check**: Mock `systemctl is-enabled`, verify enabled check
5. **Caddy Port Check**: Mock `ss`/`netstat`, verify port accessibility check
6. **Port Conflict Detection**: Mock port 80 in use by another service, verify warning is logged
7. **Caddyfile Exists Check**: Mock file existence check, verify Caddyfile detection
8. **Default Caddyfile Creation**: Mock file operations, verify default Caddyfile is created
9. **IsInstalled - Fully configured**: Mock all checks to return true, verify returns `true`
10. **IsInstalled - Not configured**: Mock checks to return false, verify returns `false`
11. **Install - Full setup**: Mock exec calls, verify GPG key addition, repository addition, Caddy installation, config directory creation, service enable/start, port check
12. **Install - Caddy already installed**: Mock Caddy installed, verify only service and port are checked
13. **Install - Service not enabled**: Mock service not enabled, verify enable command is executed
14. **Install - Service not running**: Mock service not running, verify start command is executed
15. **Install - Caddyfile exists**: Mock Caddyfile exists, verify no new Caddyfile is created
16. **Install - Caddyfile missing**: Mock Caddyfile missing, verify default Caddyfile is created
17. **Install - Caddy disabled**: Test with `Caddy.Enabled=false`, verify skip message
18. **Install - Port conflict**: Mock port 80 in use, verify warning is logged but installation proceeds
19. **Dry-run mode**: Verify commands are logged but not executed in dry-run mode
20. **Idempotency**: Run `Install()` twice, verify second run is skipped (IsInstalled returns true)
21. **Error handling**: Test GPG key download errors, repository errors, installation errors, service start errors, port check errors, file operation errors

## Files Modified

- `internal/modules/caddy/caddy.go` (new) - Caddy module implementation
- `internal/modules/caddy/caddy_test.go` (new) - Unit tests for Caddy module
- `main.go` (updated) - Register CaddyModule in registerAllModules()
- `docs/api-specs/infrastructure/infrastructure-api.md` (updated) - Add Caddy module API documentation


