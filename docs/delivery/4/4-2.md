# 4-2 Implement Netdata monitoring module

[Back to task list](./tasks.md)

## Description

Implement the Netdata monitoring module (`internal/modules/monitoring/monitoring.go`) that installs and configures Netdata using the official kickstart script. Netdata provides real-time server monitoring and performance metrics.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 00:00:00 | Created | N/A | Proposed | Task file created | sean |
| 2025-01-27 10:00:00 | Status Update | Proposed | InProgress | Started implementation | sean |
| 2025-01-27 10:30:00 | Status Update | InProgress | Review | Implementation complete, all tests passing | sean |
| 2025-01-27 10:35:00 | Status Update | Review | Done | Task approved and completed | sean |

## Requirements

1. Implement `module.Module` interface:
   - `Name() string` - Returns "monitoring"
   - `Description() string` - Returns "Installs and configures Netdata monitoring"
   - `IsInstalled() (bool, error)` - Checks if Netdata is installed and running
   - `Install(cfg *config.Config) error` - Installs and configures Netdata

2. Download and run Netdata kickstart script:
   - Download kickstart script: `curl -fsSL https://get.netdata.cloud/kickstart.sh`
   - Run script in non-interactive mode: `bash kickstart.sh --non-interactive`
   - The script handles installation, configuration, and service setup
   - Show progress during installation (kickstart script provides progress output)

3. Configure Netdata to start on boot:
   - Verify Netdata service is enabled: `systemctl is-enabled netdata`
   - Enable service if not enabled: `systemctl enable netdata`
   - Start service if not running: `systemctl start netdata`
   - Verify service is running: `systemctl is-active netdata`

4. Verify Netdata is accessible:
   - Check if Netdata is listening on port 19999: `netstat -tlnp | grep 19999` or `ss -tlnp | grep 19999`
   - Optionally verify HTTP response: `curl -s http://localhost:19999/api/v1/info`
   - Log success message with access URL

5. Optional configuration (future enhancement):
   - May need to add `Monitoring` struct to config for optional settings
   - For now, use Netdata defaults
   - Can be extended later for memory mode, retention settings, etc.

6. Idempotency:
   - `IsInstalled()` should check:
     - Netdata is installed (check if `netdata` binary exists or service exists)
     - Netdata service is running (`systemctl is-active netdata` returns "active")
     - Netdata is accessible on port 19999
   - Return `true` if all checks pass, `false` otherwise
   - Return error if checks fail

7. Error handling:
   - Handle kickstart script download errors
   - Handle kickstart script execution errors
   - Handle service start/enable errors
   - Handle port accessibility check errors
   - Log errors using `log.Error()`
   - Return descriptive errors

8. Dry-run support:
   - Check dry-run mode from logging package
   - In dry-run mode, log what would be done but don't execute commands
   - Still check current Netdata installation status

9. Logging:
   - Use `log.Info()` for progress messages (especially during kickstart script execution)
   - Use `log.Success()` when operations complete
   - Use `log.Skip()` when module is already installed
   - Show Netdata access URL after installation
   - Log kickstart script output (it provides progress information)

## Implementation Plan

1. Create `internal/modules/monitoring/` directory
2. Create `monitoring.go` with package declaration
3. Import required packages:
   - `github.com/stwalsh4118/phanes/internal/module`
   - `github.com/stwalsh4118/phanes/internal/config`
   - `github.com/stwalsh4118/phanes/internal/exec`
   - `github.com/stwalsh4118/phanes/internal/log`
   - `os` (for file operations)
   - `os/exec` (for command execution)
   - `strings` (for string operations)
   - `bytes` (for command output)
   - `io` (for streaming output)

4. Define `MonitoringModule` struct:
   ```go
   type MonitoringModule struct{}
   ```

5. Define constants:
   - Netdata kickstart script URL: `https://get.netdata.cloud/kickstart.sh`
   - Netdata default port: `19999`
   - Netdata service name: `netdata`

6. Implement `Name()` method:
   - Return "monitoring"

7. Implement `Description()` method:
   - Return "Installs and configures Netdata monitoring"

8. Implement helper function `netdataInstalled() (bool, error)`:
   - Check if `netdata` binary exists: `/usr/sbin/netdata` or `which netdata`
   - Or check if service exists: `systemctl list-unit-files | grep netdata`
   - Return true if installed, false otherwise

9. Implement helper function `netdataServiceRunning() (bool, error)`:
   - Run `systemctl is-active netdata` and check if it returns "active"
   - Return true if running, false otherwise

10. Implement helper function `netdataServiceEnabled() (bool, error)`:
    - Run `systemctl is-enabled netdata` and check if it returns "enabled"
    - Return true if enabled, false otherwise

11. Implement helper function `netdataPortAccessible() (bool, error)`:
    - Run `ss -tlnp | grep 19999` or `netstat -tlnp | grep 19999`
    - Or try HTTP request: `curl -s http://localhost:19999/api/v1/info`
    - Return true if port is accessible, false otherwise

12. Implement `IsInstalled()` method:
    - Check if Netdata is installed using `netdataInstalled()`
    - Check if Netdata service is running using `netdataServiceRunning()`
    - Check if Netdata port is accessible using `netdataPortAccessible()`
    - Return `true` if all checks pass, `false` otherwise
    - Return error if checks fail

13. Implement `Install()` method:
    - Check dry-run mode
    - Check if Netdata is already installed:
      - If installed, verify service is running and port is accessible
      - If not installed, proceed with installation
    - Download kickstart script:
      - Download: `exec.Run("curl", "-fsSL", netdataKickstartURL, "-o", "/tmp/netdata-kickstart.sh")`
      - Make executable: `exec.Run("chmod", "+x", "/tmp/netdata-kickstart.sh")`
    - Run kickstart script in non-interactive mode:
      - Execute: `exec.Run("bash", "/tmp/netdata-kickstart.sh", "--non-interactive")`
      - Capture and log output (script provides progress information)
      - Handle script errors
    - Configure Netdata service:
      - Check if enabled using `netdataServiceEnabled()`
      - If not enabled, enable: `exec.Run("systemctl", "enable", "netdata")`
      - Check if running using `netdataServiceRunning()`
      - If not running, start: `exec.Run("systemctl", "start", "netdata")`
      - Verify running: `exec.Run("systemctl", "is-active", "netdata")`
    - Verify Netdata is accessible:
      - Check port using `netdataPortAccessible()`
      - Log success message with access URL: `http://localhost:19999`
    - Clean up kickstart script:
      - Remove: `os.Remove("/tmp/netdata-kickstart.sh")`
    - Log success message
    - Return error if any step fails

14. Create unit tests in `monitoring_test.go`:
    - Test `Name()` and `Description()`
    - Test `netdataInstalled()` with mocked file/exec checks
    - Test `netdataServiceRunning()` with mocked exec calls
    - Test `netdataServiceEnabled()` with mocked exec calls
    - Test `netdataPortAccessible()` with mocked exec calls
    - Test `IsInstalled()` with various scenarios
    - Test `Install()` with mocked exec calls
    - Test dry-run mode
    - Test error handling
    - Test kickstart script download and execution

## Verification

1. Module implements `module.Module` interface correctly
2. `Name()` returns "monitoring"
3. `Description()` returns correct description
4. `IsInstalled()` correctly checks Netdata installation, service status, and port accessibility
5. `Install()` downloads kickstart script, runs it, configures service, and verifies accessibility
6. Netdata service is enabled and started correctly
7. Netdata port accessibility is verified
8. Module is idempotent (can run multiple times safely)
9. Error handling works correctly
10. Dry-run mode is respected
11. All logging is appropriate
12. Unit tests pass

## Test Plan

1. **Name and Description**: Verify `Name()` and `Description()` return correct values
2. **Netdata Installed Check**: Mock file/exec checks, verify installation detection
3. **Netdata Service Check**: Mock `systemctl is-active`, verify service status check
4. **Netdata Service Enabled Check**: Mock `systemctl is-enabled`, verify enabled check
5. **Netdata Port Check**: Mock `ss`/`netstat` or HTTP request, verify port accessibility check
6. **IsInstalled - Fully configured**: Mock all checks to return true, verify returns `true`
7. **IsInstalled - Not configured**: Mock checks to return false, verify returns `false`
8. **Install - Full setup**: Mock exec calls, verify kickstart script download, execution, service enable/start, port check
9. **Install - Netdata already installed**: Mock Netdata installed, verify only service and port are checked
10. **Install - Service not enabled**: Mock service not enabled, verify enable command is executed
11. **Install - Service not running**: Mock service not running, verify start command is executed
12. **Install - Kickstart script error**: Mock script execution failure, verify error handling
13. **Dry-run mode**: Verify commands are logged but not executed in dry-run mode
14. **Idempotency**: Run `Install()` twice, verify second run is skipped (IsInstalled returns true)
15. **Error handling**: Test kickstart script download errors, execution errors, service start errors, port check errors
16. **Kickstart script output**: Verify kickstart script output is captured and logged

## Files Modified

- `internal/modules/monitoring/monitoring.go` (new) - Netdata monitoring module implementation
- `internal/modules/monitoring/monitoring_test.go` (new) - Unit tests for monitoring module
- `docs/api-specs/infrastructure/infrastructure-api.md` (updated) - Add monitoring module API documentation

