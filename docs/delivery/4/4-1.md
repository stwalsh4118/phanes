# 4-1 Implement Docker module

[Back to task list](./tasks.md)

## Description

Implement the Docker module (`internal/modules/docker/docker.go`) that installs Docker CE and Docker Compose v2, adds the configured user to the docker group, and verifies the installation. This enables containerized application deployment.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 00:00:00 | Created | N/A | Proposed | Task file created | sean |
| 2025-01-27 12:00:00 | Status Update | Proposed | InProgress | Started implementation | sean |
| 2025-01-27 12:30:00 | Status Update | InProgress | Review | Implementation complete, all tests passing | sean |
| 2025-01-27 13:00:00 | Status Update | Review | Done | Task approved and completed, fixed user existence check | sean |

## Requirements

1. Implement `module.Module` interface:
   - `Name() string` - Returns "docker"
   - `Description() string` - Returns "Installs Docker CE and Docker Compose"
   - `IsInstalled() (bool, error)` - Checks if Docker and Docker Compose are installed
   - `Install(cfg *config.Config) error` - Installs Docker CE and Docker Compose

2. Add Docker's official GPG key and repository:
   - Install prerequisites: `apt-get update` and `apt-get install -y ca-certificates curl`
   - Download Docker's GPG key: `curl -fsSL https://download.docker.com/linux/ubuntu/gpg`
   - Add GPG key to apt keyring: `gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg`
   - Detect distribution codename (e.g., `lsb_release -cs` or read from `/etc/os-release`)
   - Add Docker repository to apt sources: `echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null`
   - Update apt package list: `apt-get update`

3. Install Docker CE packages:
   - Install packages: `apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin`
   - Verify Docker is installed: `docker --version`
   - Start and enable Docker service: `systemctl enable --now docker`
   - Verify Docker service is running: `systemctl is-active docker`

4. Install Docker Compose v2 (if enabled):
   - Check `cfg.Docker.InstallCompose` (defaults to `true`)
   - Docker Compose v2 is installed as part of `docker-compose-plugin` package
   - Verify Docker Compose is installed: `docker compose version`
   - If `InstallCompose` is false, skip Compose verification

5. Add user to docker group:
   - Get username from `cfg.User.Username`
   - Check if user is already in docker group: `groups <username>` or `id -nG <username>`
   - Add user to docker group: `usermod -aG docker <username>`
   - Warn user that they need to logout/login for group changes to take effect
   - Log warning message about logout/login requirement

6. Idempotency:
   - `IsInstalled()` should check:
     - Docker is installed (`docker --version` succeeds)
     - Docker service is running (`systemctl is-active docker` returns "active")
     - Docker Compose is installed if `InstallCompose` is true (`docker compose version` succeeds)
     - User is in docker group (if username is provided)
   - Return `true` if all checks pass, `false` otherwise
   - Return error if checks fail

7. Error handling:
   - Handle GPG key download errors
   - Handle repository addition errors
   - Handle Docker installation errors
   - Handle Docker service start errors
   - Handle user group addition errors
   - Log errors using `log.Error()`
   - Return descriptive errors

8. Dry-run support:
   - Check dry-run mode from logging package
   - In dry-run mode, log what would be done but don't execute commands
   - Still check current Docker installation status

9. Logging:
   - Use `log.Info()` for progress messages (especially during installation)
   - Use `log.Success()` when operations complete
   - Use `log.Skip()` when module is already installed
   - Use `log.Warn()` when user needs to logout/login for docker group changes
   - Show installation progress for Docker packages

## Implementation Plan

1. Create `internal/modules/docker/` directory
2. Create `docker.go` with package declaration
3. Import required packages:
   - `github.com/stwalsh4118/phanes/internal/module`
   - `github.com/stwalsh4118/phanes/internal/config`
   - `github.com/stwalsh4118/phanes/internal/exec`
   - `github.com/stwalsh4118/phanes/internal/log`
   - `os` (for file operations)
   - `os/exec` (for command execution)
   - `strings` (for string operations)
   - `bytes` (for command output)

4. Define `DockerModule` struct:
   ```go
   type DockerModule struct{}
   ```

5. Define constants:
   - Docker GPG key URL: `https://download.docker.com/linux/ubuntu/gpg`
   - Docker repository URL: `https://download.docker.com/linux/ubuntu`
   - Docker GPG keyring path: `/usr/share/keyrings/docker-archive-keyring.gpg`
   - Docker apt sources path: `/etc/apt/sources.list.d/docker.list`

6. Implement `Name()` method:
   - Return "docker"

7. Implement `Description()` method:
   - Return "Installs Docker CE and Docker Compose"

8. Implement helper function `dockerInstalled() (bool, error)`:
   - Run `docker --version` and check if it succeeds
   - Return true if installed, false otherwise

9. Implement helper function `dockerServiceRunning() (bool, error)`:
   - Run `systemctl is-active docker` and check if it returns "active"
   - Return true if running, false otherwise

10. Implement helper function `dockerComposeInstalled() (bool, error)`:
    - Run `docker compose version` and check if it succeeds
    - Return true if installed, false otherwise

11. Implement helper function `userInDockerGroup(username string) (bool, error)`:
    - Run `id -nG <username>` or `groups <username>`
    - Check if output contains "docker"
    - Return true if user is in group, false otherwise

12. Implement helper function `getDistributionCodename() (string, error)`:
    - Run `lsb_release -cs` or read from `/etc/os-release`
    - Return distribution codename (e.g., "jammy", "focal")

13. Implement `IsInstalled()` method:
    - Check if Docker is installed using `dockerInstalled()`
    - Check if Docker service is running using `dockerServiceRunning()`
    - Check if Docker Compose is installed (always check, since we can't access config here)
    - Return `true` if all checks pass, `false` otherwise
    - Return error if checks fail
    - Note: User group check is done in `Install()` since we need config

14. Implement `Install()` method:
    - Check dry-run mode
    - Validate config (username should be set)
    - Check if Docker is already installed:
      - If installed, verify service is running and user is in group
      - If not installed, proceed with installation
    - Add Docker GPG key and repository:
      - Install prerequisites: `exec.Run("apt-get", "update")` and `exec.Run("apt-get", "install", "-y", "ca-certificates", "curl")`
      - Download GPG key: `exec.Run("curl", "-fsSL", dockerGPGKeyURL)`
      - Add GPG key: `exec.Run("gpg", "--dearmor", "-o", dockerGPGKeyringPath)`
      - Get distribution codename: `getDistributionCodename()`
      - Add repository: write to `/etc/apt/sources.list.d/docker.list`
      - Update apt: `exec.Run("apt-get", "update")`
    - Install Docker CE packages:
      - Install: `exec.Run("apt-get", "install", "-y", "docker-ce", "docker-ce-cli", "containerd.io", "docker-buildx-plugin", "docker-compose-plugin")`
      - Verify: `exec.Run("docker", "--version")`
      - Start service: `exec.Run("systemctl", "enable", "--now", "docker")`
      - Verify running: `exec.Run("systemctl", "is-active", "docker")`
    - Install Docker Compose v2 (if enabled):
      - Check `cfg.Docker.InstallCompose`
      - If true, verify: `exec.Run("docker", "compose", "version")`
      - If false, skip Compose verification
    - Add user to docker group:
      - Check if user is in group using `userInDockerGroup()`
      - If not in group, add: `exec.Run("usermod", "-aG", "docker", cfg.User.Username)`
      - Log warning about logout/login requirement
    - Log success message
    - Return error if any step fails

15. Create unit tests in `docker_test.go`:
    - Test `Name()` and `Description()`
    - Test `dockerInstalled()` with mocked exec calls
    - Test `dockerServiceRunning()` with mocked exec calls
    - Test `dockerComposeInstalled()` with mocked exec calls
    - Test `userInDockerGroup()` with mocked exec calls
    - Test `getDistributionCodename()` with mocked exec calls
    - Test `IsInstalled()` with various scenarios
    - Test `Install()` with mocked exec calls
    - Test Docker Compose disabled scenario
    - Test dry-run mode
    - Test error handling
    - Test user group warning

## Verification

1. Module implements `module.Module` interface correctly
2. `Name()` returns "docker"
3. `Description()` returns correct description
4. `IsInstalled()` correctly checks Docker installation and service status
5. `Install()` adds GPG key, adds repository, installs Docker CE, starts service, and adds user to group
6. Docker Compose installation respects `cfg.Docker.InstallCompose` flag
7. User is added to docker group correctly
8. Warning is shown when user needs to logout/login
9. Module is idempotent (can run multiple times safely)
10. Error handling works correctly
11. Dry-run mode is respected
12. All logging is appropriate
13. Unit tests pass

## Test Plan

1. **Name and Description**: Verify `Name()` and `Description()` return correct values
2. **Docker Installed Check**: Mock `docker --version`, verify installation detection
3. **Docker Service Check**: Mock `systemctl is-active`, verify service status check
4. **Docker Compose Check**: Mock `docker compose version`, verify Compose detection
5. **User Group Check**: Mock `id -nG`, verify group membership check
6. **Distribution Codename**: Mock `lsb_release -cs`, verify codename detection
7. **IsInstalled - Fully configured**: Mock all checks to return true, verify returns `true`
8. **IsInstalled - Not configured**: Mock checks to return false, verify returns `false`
9. **Install - Full setup**: Mock exec calls, verify GPG key addition, repository addition, Docker installation, service start, user group addition
10. **Install - Docker already installed**: Mock Docker installed, verify only user group is checked/added
11. **Install - Compose disabled**: Test with `InstallCompose=false`, verify Compose is not verified
12. **Install - User already in group**: Mock user in group, verify no usermod call
13. **Install - User group warning**: Verify warning is logged when user is added to group
14. **Dry-run mode**: Verify commands are logged but not executed in dry-run mode
15. **Idempotency**: Run `Install()` twice, verify second run is skipped (IsInstalled returns true)
16. **Error handling**: Test GPG key download errors, repository errors, installation errors, service start errors

## Files Modified

- `internal/modules/docker/docker.go` (new) - Docker module implementation
- `internal/modules/docker/docker_test.go` (new) - Unit tests for Docker module
- `main.go` (updated) - Register DockerModule in registerAllModules()
- `docs/api-specs/infrastructure/infrastructure-api.md` (updated) - Add Docker module API documentation

