# 12-2 Implement Backup Module

[Back to task list](./tasks.md)

## Description

Create `internal/modules/backup/backup.go` implementing the Module interface to install and configure restic backup tool with automated scheduling.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 00:00:00 | Created | N/A | Proposed | Task file created | sean |

## Requirements

1. Create `internal/modules/backup/backup.go` file
2. Implement `BackupModule` struct with Module interface:
   - `Name()` returns "backup"
   - `Description()` returns "Installs and configures restic backup"
   - `IsInstalled()` checks:
     - `restic` command exists
     - Repository is initialized (check if repository exists)
     - Backup script exists at `/usr/local/bin/phanes-backup.sh`
     - Systemd timer exists (preferred) or cron job is configured
   - `Install(cfg)`:
     - Skip if Backup not enabled in config
     - Install restic via apt (`apt-get install -y restic`)
     - Initialize repository if not exists (support local/S3/B2/SFTP backends):
       - Local: `restic init --repo <path>`
       - S3: `restic init --repo s3:<bucket>/<path>`
       - B2: `restic init --repo b2:<bucket>:<path>`
       - SFTP: `restic init --repo sftp:<user>@<host>:<path>`
     - Create password file at `/etc/phanes/restic-password` with secure permissions (0600)
     - Create backup script at `/usr/local/bin/phanes-backup.sh`:
       - Uses restic to backup configured paths
       - Handles repository authentication via password file
       - Logs backup results to `/var/log/phanes-backup.log`
       - Handles errors gracefully
     - Set up systemd timer (preferred) or cron job:
       - Create systemd service unit `/etc/systemd/system/phanes-backup.service`
       - Create systemd timer unit `/etc/systemd/system/phanes-backup.timer`
       - Enable and start timer
       - Fallback to cron if systemd not available
     - Validate repository connectivity after initialization
     - Display repository location and schedule information after installation
3. Support dry-run mode
4. Implement idempotency checks (skip if already installed)
5. Add appropriate error handling and logging

## Implementation Plan

1. Create `internal/modules/backup/` directory
2. Create `backup.go` file with package declaration
3. Import required packages (config, exec, log, module, os, path/filepath, etc.)
4. Define constants:
   - Backup script path: `/usr/local/bin/phanes-backup.sh`
   - Password file path: `/etc/phanes/restic-password`
   - Backup log path: `/var/log/phanes-backup.log`
   - Systemd service path: `/etc/systemd/system/phanes-backup.service`
   - Systemd timer path: `/etc/systemd/system/phanes-backup.timer`
5. Implement helper functions:
   - `resticInstalled()` - Check if restic command exists
   - `repositoryInitialized(repo string)` - Check if repository is initialized
   - `backupScriptExists()` - Check if backup script exists
   - `timerConfigured()` - Check if systemd timer or cron job exists
   - `detectRepositoryType(repo string)` - Detect repository backend type
   - `initializeRepository(repo, password string)` - Initialize restic repository
   - `createPasswordFile(password string)` - Create secure password file
   - `createBackupScript(cfg *config.Config)` - Generate backup script content
   - `setupSystemdTimer(schedule string)` - Create systemd timer and service
   - `setupCronJob(schedule string)` - Create cron job (fallback)
   - `validateRepository(repo string)` - Test repository connectivity
6. Implement `BackupModule` struct
7. Implement `Name()` method
8. Implement `Description()` method
9. Implement `IsInstalled()` method using helper functions
10. Implement `Install()` method with:
    - Config validation (check if enabled)
    - Repository and password validation
    - Installation steps with dry-run support
    - Repository initialization
    - Password file creation
    - Backup script creation
    - Timer/cron configuration
    - Repository validation
    - Status display
11. Add interface compliance check: `var _ module.Module = (*BackupModule)(nil)`

## Verification

1. Module compiles without errors
2. Module implements Module interface correctly
3. `IsInstalled()` correctly detects installation state
4. `Install()` correctly installs and configures restic backup
5. Module is idempotent (safe to run multiple times)
6. Dry-run mode works correctly
7. Error handling is appropriate
8. Backup script handles errors gracefully
9. Repository password is stored securely (0600 permissions)
10. Repository connectivity is validated

## Files Modified

- `internal/modules/backup/backup.go` (new) - Backup module implementation

