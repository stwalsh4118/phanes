# 12-4 E2E CoS Test

[Back to task list](./tasks.md)

## Description

Verify all acceptance criteria from the PBI 12 PRD work correctly in both normal and dry-run modes.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 00:00:00 | Created | N/A | Proposed | Task file created | sean |

## Requirements

Verify all acceptance criteria from PBI 12 PRD:

1. Module installs restic backup tool
2. Module configures a backup repository (local or remote)
3. Module sets up cron/systemd timer for automated backups
4. Config struct includes backup section with all required fields
5. Module is idempotent (safe to run multiple times)
6. Backup script handles errors gracefully
7. Repository password is stored securely
8. Module validates repository connectivity

Test in both normal and dry-run modes.

## Implementation Plan

1. Create integration test file `test/integration/backup_test.go` (if appropriate)
2. Test scenarios:
   - Test module installation with valid configuration (local repository)
   - Test module skips when Backup is disabled in config
   - Test `IsInstalled()` detects existing installation
   - Test idempotency (run install twice, second time should skip)
   - Test repository initialization for different backends (local, S3, B2, SFTP)
   - Test password file is created with secure permissions (0600)
   - Test backup script is created and executable
   - Test systemd timer is created and enabled (or cron job if systemd unavailable)
   - Test repository connectivity validation
   - Test backup script error handling
   - Test dry-run mode produces correct output
   - Test validation rejects empty repository when enabled
   - Test validation rejects empty password when enabled
3. Manual verification:
   - Run phanes with Backup module enabled and valid local repository configuration
   - Verify restic is installed
   - Verify repository is initialized
   - Verify password file exists with correct permissions
   - Verify backup script exists and is executable
   - Verify systemd timer is enabled and scheduled (or cron job)
   - Verify repository connectivity test passes
   - Run phanes again to verify idempotency
   - Test with invalid repository configuration
   - Test with missing password
   - Test dry-run mode
   - Manually run backup script to verify it works
   - Verify backup script logs to `/var/log/phanes-backup.log`

## Verification

1. All test scenarios pass
2. All acceptance criteria are verified
3. Module works correctly in both normal and dry-run modes
4. Manual testing confirms all functionality
5. Backup script executes successfully and handles errors
6. Repository password is stored securely (0600 permissions)
7. Systemd timer or cron job is properly configured

## Files Modified

- `test/integration/backup_test.go` (new, if appropriate) - E2E tests for Backup module

