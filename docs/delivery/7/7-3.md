# 7-3 Implement DevTools module - Node.js via nvm

[Back to task list](./tasks.md)

## Description

Implement helper functions for installing nvm (Node Version Manager) and Node.js LTS version. nvm is installed per-user in the user's home directory.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 00:00:00 | Created | N/A | Proposed | Task file created | sean |
| 2025-01-27 00:00:00 | Status Change | Proposed | InProgress | Started implementation | ai-agent |
| 2025-01-27 00:00:00 | Status Change | InProgress | Review | Implementation complete, code compiles successfully | ai-agent |
| 2025-01-27 00:00:00 | Status Change | Review | Done | Task completed and verified | ai-agent |

## Requirements

1. Create helper functions in `internal/modules/devtools/nodejs.go`:
   - `installNodeJS(cfg *config.Config) error` - Installs nvm and Node.js
   - `nvmInstalled(username string) (bool, error)` - Checks if nvm is installed for user
   - `nodeInstalled(username, version string) (bool, error)` - Checks if Node.js version is installed

2. Install nvm:
   - Download and run nvm install script: `curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.0/install.sh | bash`
   - Install to user's home directory: `~/.nvm`
   - Configure shell profile (`.bashrc` and `.zshrc`) to source nvm
   - Requires `cfg.User.Username` to be set

3. Install Node.js:
   - Use nvm to install Node.js LTS version (from `cfg.DevTools.NodeVersion`, default "22")
   - Command: `source ~/.nvm/nvm.sh && nvm install <version> && nvm use <version> && nvm alias default <version>`
   - Verify installation: `node --version` and `npm --version`

4. Shell profile configuration:
   - Append nvm initialization to `.bashrc` and `.zshrc` if not already present
   - Check for existing nvm initialization to avoid duplicates
   - Pattern: `export NVM_DIR="$HOME/.nvm"` and `[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"`

5. Idempotency:
   - Check if nvm is already installed before installing
   - Check if Node.js version is already installed before installing
   - Return early if already configured

6. Error handling:
   - Handle missing username error
   - Handle nvm installation script errors
   - Handle Node.js installation errors
   - Handle shell profile write errors
   - Return descriptive errors

7. Logging:
   - Use `log.Info()` for progress messages
   - Use `log.Success()` when installation completes
   - Use `log.Skip()` when already installed
   - Use `log.Warn()` if username is not set

8. Dry-run support:
   - Check dry-run mode from logging package
   - Log what would be done but don't execute commands

## Implementation Plan

1. Create `internal/modules/devtools/nodejs.go`
2. Implement helper functions for checking nvm and Node.js installation
3. Implement `installNodeJS()` function
4. Implement shell profile configuration helpers
5. Add proper error handling and logging
6. Add dry-run support

## Verification

1. Functions compile without errors
2. nvm installation works correctly
3. Node.js installation works correctly
4. Shell profile configuration works correctly
5. Idempotency works (can run multiple times safely)
6. Error handling works correctly
7. Dry-run mode is respected

## Files Modified

- `internal/modules/devtools/nodejs.go` (new) - Node.js/nvm installation functions
- `docs/api-specs/infrastructure/infrastructure-api.md` - Added Node.js/nvm API documentation
