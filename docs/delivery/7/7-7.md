# 7-7 Implement Coolify module

[Back to task list](./tasks.md)

## Description

Implement the Coolify module that installs Coolify, a self-hosted PaaS platform. Coolify requires Docker to be installed and running.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 00:00:00 | Created | N/A | Proposed | Task file created | sean |
| 2025-01-27 00:00:00 | Status Change | Proposed | InProgress | Started implementation | ai-agent |
| 2025-01-27 00:00:00 | Status Change | InProgress | Review | Implementation complete, code compiles successfully | ai-agent |
| 2025-01-27 00:00:00 | Status Change | Review | Done | Task completed and verified | ai-agent |

## Requirements

1. Implement `module.Module` interface in `internal/modules/coolify/coolify.go`:
   - `Name() string` - Returns "coolify"
   - `Description() string` - Returns "Installs and configures Coolify self-hosted PaaS"
   - `IsInstalled() (bool, error)` - Checks if Coolify is installed and running
   - `Install(cfg *config.Config) error` - Installs and configures Coolify

2. Check Docker dependency:
   - Verify Docker is installed: `docker --version`
   - Verify Docker service is running: `systemctl is-active docker`
   - Return error if Docker is not installed or not running
   - Log warning if Docker is not available

3. Install Coolify:
   - Use official Coolify install script: `curl -fsSL https://cdn.coollabs.io/coolify/install.sh | bash`
   - Run script as root or with sudo
   - Script handles Docker Compose setup and configuration
   - Verify installation: Check if Coolify containers are running

4. Verify Coolify is running:
   - Check if Coolify containers are running: `docker ps | grep coolify`
   - Check if Coolify web interface is accessible (optional)
   - Log success message with access URL if available

5. Configuration flags:
   - Respect `cfg.Coolify.Enabled` flag (default `true`)
   - If `Enabled` is `false`, skip installation and log skip message
   - If `Enabled` is `true`, proceed with installation

6. Idempotency:
   - `IsInstalled()` should check:
     - Docker is installed and running
     - Coolify containers are running
   - Return `true` if all checks pass, `false` otherwise
   - Return error if checks fail

7. Error handling:
   - Handle Docker dependency errors
   - Handle Coolify installation script errors
   - Handle Docker Compose errors
   - Handle container verification errors
   - Log errors using `log.Error()`
   - Return descriptive errors

8. Logging:
   - Use `log.Info()` for progress messages
   - Use `log.Success()` when installation completes
   - Use `log.Skip()` when module is disabled or already installed
   - Use `log.Warn()` if Docker is not available
   - Show Coolify access URL after installation

9. Dry-run support:
   - Check dry-run mode from logging package
   - In dry-run mode, log what would be done but don't execute commands
   - Still check Docker dependency

10. Register module in `main.go`:
    - Add import: `"github.com/stwalsh4118/phanes/internal/modules/coolify"`
    - Add registration: `r.RegisterModule(&coolify.CoolifyModule{})`

11. Create unit tests in `coolify_test.go`:
    - Test `Name()` and `Description()`
    - Test `IsInstalled()` with various scenarios
    - Test `Install()` with mocked exec calls
    - Test Docker dependency check
    - Test `Coolify.Enabled=false` scenario
    - Test error handling
    - Test dry-run mode

## Implementation Plan

1. Create `internal/modules/coolify/` directory
2. Create `coolify.go` with package declaration
3. Import required packages (module, config, exec, log)
4. Define `CoolifyModule` struct
5. Define constants (Coolify install script URL, etc.)
6. Implement `Name()` and `Description()` methods
7. Implement helper functions for checking Docker and Coolify status
8. Implement `IsInstalled()` method
9. Implement `Install()` method
10. Add proper error handling and logging
11. Add dry-run support
12. Register module in `main.go`
13. Create unit tests

## Verification

1. Module implements `module.Module` interface correctly
2. `Name()` returns "coolify"
3. `Description()` returns correct description
4. `IsInstalled()` correctly checks Docker and Coolify status
5. `Install()` checks Docker dependency before installing
6. `Install()` runs Coolify install script correctly
7. `cfg.Coolify.Enabled` flag is respected
8. Module is idempotent (can run multiple times safely)
9. Error handling works correctly
10. Dry-run mode is respected
11. All logging is appropriate
12. Unit tests pass
13. Module is registered in main.go

## Files Modified

- `internal/modules/coolify/coolify.go` (new) - Coolify module implementation
- `internal/modules/coolify/coolify_test.go` (new) - Unit tests for Coolify module
- `main.go` (updated) - Register CoolifyModule in registerAllModules()
- `docs/api-specs/infrastructure/infrastructure-api.md` (updated) - Added Coolify API documentation
- `test/vm/Vagrantfile` (updated) - Added port forwarding for Coolify web interface (port 8000)


