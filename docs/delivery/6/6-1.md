# 6-1 Implement PostgreSQL module

[Back to task list](./tasks.md)

## Description

Implement the PostgreSQL module (`internal/modules/postgres/postgres.go`) that installs PostgreSQL via official APT repository, creates initial database and user, configures PostgreSQL for local connections, enables and starts the service, and verifies it is running and accepting connections. The module supports configurable PostgreSQL version and secure password handling.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 00:00:00 | Created | N/A | Proposed | Task file created | sean |
| 2025-12-25 13:01:45 | Status Update | Proposed | Done | Implementation complete, all tests passing | sean |

## Requirements

1. Implement `module.Module` interface:
   - `Name() string` - Returns "postgres"
   - `Description() string` - Returns "Installs and configures PostgreSQL database server"
   - `IsInstalled() (bool, error)` - Checks if PostgreSQL is installed and running
   - `Install(cfg *config.Config) error` - Installs and configures PostgreSQL

2. Add PostgreSQL's official APT repository:
   - Install prerequisites: `apt-get update` and `apt-get install -y wget ca-certificates`
   - Add PostgreSQL GPG key: Download from `https://www.postgresql.org/media/keys/ACCC4CF8.asc` and add to keyring
   - Add PostgreSQL repository: `deb http://apt.postgresql.org/pub/repos/apt/ <codename>-pgdg main`
   - Update apt package list: `apt-get update`

3. Install PostgreSQL via apt:
   - Install PostgreSQL package: `apt-get install -y postgresql-<version>` (e.g., `postgresql-16`)
   - Verify PostgreSQL is installed: `psql --version`
   - Use version from `cfg.Postgres.Version` (default "16" if not specified)

4. Create initial database and user:
   - Check if database exists: `psql -U postgres -lqt | cut -d \| -f 1 | grep -qw <database>`
   - Create database if it doesn't exist: `createdb -U postgres <database>`
   - Check if user exists: `psql -U postgres -tAc "SELECT 1 FROM pg_roles WHERE rolname='<user>'" | grep -q 1`
   - Create user if it doesn't exist: `psql -U postgres -c "CREATE USER <user> WITH PASSWORD '<password>';"`
   - Grant privileges: `psql -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE <database> TO <user>;"`
   - Use database name from `cfg.Postgres.Database` (default "phanes" if not specified)
   - Use user name from `cfg.Postgres.User` (default "phanes" if not specified)
   - Use password from `cfg.Postgres.Password` (required, error if empty)

5. Configure PostgreSQL for local connections:
   - Check if `pg_hba.conf` allows local connections
   - Ensure `pg_hba.conf` has entry: `local all all peer` or `host all all 127.0.0.1/32 md5`
   - PostgreSQL config directory: `/etc/postgresql/<version>/main/`
   - `pg_hba.conf` path: `/etc/postgresql/<version>/main/pg_hba.conf`
   - Reload PostgreSQL configuration: `systemctl reload postgresql` or `pg_ctlcluster <version> main reload`

6. Configure PostgreSQL service:
   - Check if service is enabled: `systemctl is-enabled postgresql`
   - Enable service if not enabled: `systemctl enable postgresql`
   - Check if service is running: `systemctl is-active postgresql`
   - Start service if not running: `systemctl start postgresql`
   - Verify service is running: `systemctl is-active postgresql`

7. Verify PostgreSQL is accessible:
   - Check if PostgreSQL is listening on port 5432: `ss -tlnp | grep :5432` or `netstat -tlnp | grep :5432`
   - Test connection: `psql -U postgres -c "SELECT version();"`
   - Log success message with connection details

8. Configuration flags:
   - Respect `cfg.Postgres.Enabled` flag (default `true`)
   - If `Enabled` is `false`, skip installation and log skip message
   - If `Enabled` is `true`, proceed with installation
   - Validate `cfg.Postgres.Password` is not empty (required)
   - Use `cfg.Postgres.Version` (default "16" if empty)
   - Use `cfg.Postgres.Database` (default "phanes" if empty)
   - Use `cfg.Postgres.User` (default "phanes" if empty)

9. Password security:
   - Never log passwords in any form
   - Use environment variables or command-line arguments for password passing
   - Use `PGPASSWORD` environment variable for `psql` commands when needed
   - Ensure passwords are not visible in process lists

10. Idempotency:
    - `IsInstalled()` should check:
      - PostgreSQL is installed (`psql --version` succeeds or package exists)
      - PostgreSQL service is running (`systemctl is-active postgresql` returns "active")
      - PostgreSQL is listening on port 5432
    - Return `true` if all checks pass, `false` otherwise
    - Return error if checks fail

11. Error handling:
    - Handle GPG key download errors
    - Handle repository addition errors
    - Handle apt update errors
    - Handle PostgreSQL installation errors
    - Handle database/user creation errors
    - Handle service start/enable errors
    - Handle port accessibility check errors
    - Handle configuration file errors
    - Log errors using `log.Error()`
    - Return descriptive errors

12. Dry-run support:
    - Check dry-run mode from logging package
    - In dry-run mode, log what would be done but don't execute commands
    - Still check current PostgreSQL installation status

13. Logging:
    - Use `log.Info()` for progress messages (especially during installation)
    - Use `log.Success()` when operations complete
    - Use `log.Skip()` when module is already installed or disabled
    - Use `log.Warn()` when configuration issues are detected
    - Show PostgreSQL connection details after installation (without password)
    - Never log passwords or sensitive information

## Implementation Plan

1. Create `internal/modules/postgres/` directory
2. Create `postgres.go` with package declaration
3. Import required packages:
   - `github.com/stwalsh4118/phanes/internal/module`
   - `github.com/stwalsh4118/phanes/internal/config`
   - `github.com/stwalsh4118/phanes/internal/exec`
   - `github.com/stwalsh4118/phanes/internal/log`
   - `fmt` (for string formatting)
   - `os` (for file operations and environment variables)
   - `strings` (for string operations)
   - `os/exec` (for environment variable handling in psql commands)

4. Define `PostgresModule` struct:
   ```go
   type PostgresModule struct{}
   ```

5. Define constants:
   - PostgreSQL service name: `postgresql`
   - PostgreSQL default port: `5432`
   - PostgreSQL GPG key URL: `https://www.postgresql.org/media/keys/ACCC4CF8.asc`
   - PostgreSQL GPG keyring path: `/usr/share/keyrings/postgresql-archive-keyring.gpg`
   - PostgreSQL APT sources path: `/etc/apt/sources.list.d/pgdg.list`
   - PostgreSQL repository base URL: `http://apt.postgresql.org/pub/repos/apt/`
   - Default PostgreSQL version: `"16"`
   - Default database name: `"phanes"`
   - Default user name: `"phanes"`

6. Implement `Name()` method:
   - Return "postgres"

7. Implement `Description()` method:
   - Return "Installs and configures PostgreSQL database server"

8. Implement helper function `getDistributionCodename() (string, error)`:
   - Reuse pattern from docker module or create similar function
   - Try `lsb_release -cs` first
   - Fallback to reading `/etc/os-release`
   - Return distribution codename (e.g., "jammy", "focal")

9. Implement helper function `postgresInstalled() (bool, error)`:
   - Check if `psql` binary exists: `/usr/bin/psql` or `which psql`
   - Or run `psql --version` and check if it succeeds
   - Or check if package is installed: `dpkg -l | grep postgresql`
   - Return true if installed, false otherwise

10. Implement helper function `postgresServiceRunning() (bool, error)`:
    - Run `systemctl is-active postgresql` and check if it returns "active"
    - Return true if running, false otherwise

11. Implement helper function `postgresServiceEnabled() (bool, error)`:
    - Run `systemctl is-enabled postgresql` and check if it returns "enabled" or "enabled-runtime"
    - Return true if enabled, false otherwise

12. Implement helper function `postgresPortAccessible() (bool, error)`:
    - Try `ss -tlnp` first (more modern), fallback to `netstat -tlnp`
    - Check if port 5432 is in the output: `:5432`
    - Return true if port is accessible, false otherwise
    - Return error if both commands fail

13. Implement helper function `databaseExists(databaseName string) (bool, error)`:
    - Run `psql -U postgres -lqt` and parse output
    - Check if database name exists in list
    - Return true if exists, false otherwise

14. Implement helper function `userExists(userName string) (bool, error)`:
    - Run `psql -U postgres -tAc "SELECT 1 FROM pg_roles WHERE rolname='<user>'"` and check output
    - Return true if user exists, false otherwise

15. Implement helper function `createDatabase(databaseName string) error`:
    - Run `createdb -U postgres <database>` or `psql -U postgres -c "CREATE DATABASE <database>;"`
    - Return error if creation fails

16. Implement helper function `createUser(userName, password string) error`:
    - Use `PGPASSWORD` environment variable or `psql` command with password
    - Run `psql -U postgres -c "CREATE USER <user> WITH PASSWORD '<password>';"`
    - Ensure password is passed securely (via environment variable)
    - Return error if creation fails

17. Implement helper function `grantPrivileges(databaseName, userName string) error`:
    - Run `psql -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE <database> TO <user>;"`
    - Return error if grant fails

18. Implement helper function `getPostgresVersion() (string, error)`:
    - Determine installed PostgreSQL version from package or `psql --version`
    - Return version string (e.g., "16")

19. Implement helper function `getPostgresConfigDir(version string) string`:
    - Return `/etc/postgresql/<version>/main/`

20. Implement helper function `pgHbaConfigured(version string) (bool, error)`:
    - Check if `pg_hba.conf` allows local connections
    - Read `/etc/postgresql/<version>/main/pg_hba.conf`
    - Check for appropriate entries (local all all peer or host all all 127.0.0.1/32 md5)
    - Return true if configured, false otherwise

21. Implement helper function `configurePgHba(version string) error`:
    - Ensure `pg_hba.conf` has appropriate entries for local connections
    - May need to append or modify existing entries
    - Reload PostgreSQL configuration after changes
    - Return error if configuration fails

22. Implement `IsInstalled()` method:
    - Check if PostgreSQL is installed using `postgresInstalled()`
    - Check if PostgreSQL service is running using `postgresServiceRunning()`
    - Check if PostgreSQL port is accessible using `postgresPortAccessible()`
    - Return `true` if all checks pass, `false` otherwise
    - Return error if checks fail

23. Implement `Install()` method:
    - Check dry-run mode
    - Check `cfg.Postgres.Enabled` flag:
      - If `false`, log skip message and return nil
      - If `true`, proceed with installation
    - Validate `cfg.Postgres.Password` is not empty (return error if empty)
    - Get PostgreSQL version from config (default to "16" if empty)
    - Get database name from config (default to "phanes" if empty)
    - Get user name from config (default to "phanes" if empty)
    - Check if PostgreSQL is already installed:
      - If installed, verify service is running and port is accessible
      - If not installed, proceed with installation
    - Add PostgreSQL's apt repository:
      - Install prerequisites: `exec.Run("apt-get", "update")` and `exec.Run("apt-get", "install", "-y", "wget", "ca-certificates")`
      - Download GPG key: `exec.Run("wget", "--quiet", "-O", "-", postgresGPGKeyURL)`
      - Add GPG key: `exec.Run("gpg", "--dearmor", "-o", postgresGPGKeyringPath)`
      - Get distribution codename using `getDistributionCodename()`
      - Add repository: Write to `/etc/apt/sources.list.d/pgdg.list`
      - Update apt: `exec.Run("apt-get", "update")`
    - Install PostgreSQL:
      - Install: `exec.Run("apt-get", "install", "-y", fmt.Sprintf("postgresql-%s", version))`
      - Verify: `exec.Run("psql", "--version")`
    - Configure PostgreSQL service:
      - Check if enabled using `postgresServiceEnabled()`
      - If not enabled, enable: `exec.Run("systemctl", "enable", "postgresql")`
      - Check if running using `postgresServiceRunning()`
      - If not running, start: `exec.Run("systemctl", "start", "postgresql")`
      - Verify running: `exec.Run("systemctl", "is-active", "postgresql")`
    - Configure `pg_hba.conf`:
      - Check if configured using `pgHbaConfigured(version)`
      - If not configured, configure using `configurePgHba(version)`
      - Reload PostgreSQL: `exec.Run("systemctl", "reload", "postgresql")`
    - Create database and user:
      - Check if database exists using `databaseExists(databaseName)`
      - If not exists, create using `createDatabase(databaseName)`
      - Check if user exists using `userExists(userName)`
      - If not exists, create using `createUser(userName, password)`
      - Grant privileges using `grantPrivileges(databaseName, userName)`
    - Verify PostgreSQL is accessible:
      - Check port using `postgresPortAccessible()`
      - Test connection: `exec.Run("psql", "-U", "postgres", "-c", "SELECT version();")`
      - Log success message with connection details (without password)
    - Log success message
    - Return error if any step fails

24. Update config structure in `internal/config/config.go`:
    - Add `Enabled bool` field to `Postgres` struct
    - Add `Database string` field to `Postgres` struct
    - Add `User string` field to `Postgres` struct
    - Update `DefaultConfig()` to set defaults:
      - `Enabled: true`
      - `Database: "phanes"`
      - `User: "phanes"`
      - `Version: "16"`
      - `Password: ""`

25. Register module in `main.go`:
    - Add import: `"github.com/stwalsh4118/phanes/internal/modules/postgres"`
    - Add registration: `r.RegisterModule(&postgres.PostgresModule{})`

26. Create unit tests in `postgres_test.go`:
    - Test `Name()` and `Description()`
    - Test `postgresInstalled()` with mocked file/exec checks
    - Test `postgresServiceRunning()` with mocked exec calls
    - Test `postgresServiceEnabled()` with mocked exec calls
    - Test `postgresPortAccessible()` with mocked exec calls
    - Test `databaseExists()` with mocked exec calls
    - Test `userExists()` with mocked exec calls
    - Test `createDatabase()` with mocked exec calls
    - Test `createUser()` with mocked exec calls (ensure password not logged)
    - Test `grantPrivileges()` with mocked exec calls
    - Test `pgHbaConfigured()` with mocked file reads
    - Test `configurePgHba()` with mocked file operations
    - Test `IsInstalled()` with various scenarios
    - Test `Install()` with mocked exec calls
    - Test `Postgres.Enabled=false` scenario
    - Test empty password validation
    - Test database/user creation
    - Test dry-run mode
    - Test error handling

## Verification

1. Module implements `module.Module` interface correctly
2. `Name()` returns "postgres"
3. `Description()` returns correct description
4. `IsInstalled()` correctly checks PostgreSQL installation, service status, and port accessibility
5. `Install()` adds GPG key, adds repository, installs PostgreSQL, configures service, creates database/user, and verifies accessibility
6. PostgreSQL service is enabled and started correctly
7. PostgreSQL port accessibility is verified
8. Database and user are created correctly
9. Passwords are never logged
10. `cfg.Postgres.Enabled` flag is respected
11. `cfg.Postgres.Password` validation works (error if empty)
12. Config defaults are applied correctly
13. Module is idempotent (can run multiple times safely)
14. Error handling works correctly
15. Dry-run mode is respected
16. All logging is appropriate
17. Unit tests pass

## Test Plan

1. **Name and Description**: Verify `Name()` and `Description()` return correct values
2. **PostgreSQL Installed Check**: Mock file/exec checks, verify installation detection
3. **PostgreSQL Service Check**: Mock `systemctl is-active`, verify service status check
4. **PostgreSQL Service Enabled Check**: Mock `systemctl is-enabled`, verify enabled check
5. **PostgreSQL Port Check**: Mock `ss`/`netstat`, verify port accessibility check
6. **Database Exists Check**: Mock `psql -lqt`, verify database detection
7. **User Exists Check**: Mock `psql` query, verify user detection
8. **Database Creation**: Mock `createdb`/`psql`, verify database creation
9. **User Creation**: Mock `psql` with password, verify user creation (ensure password not logged)
10. **Privilege Granting**: Mock `psql`, verify privilege granting
11. **pg_hba.conf Configuration**: Mock file operations, verify configuration
12. **IsInstalled - Fully configured**: Mock all checks to return true, verify returns `true`
13. **IsInstalled - Not configured**: Mock checks to return false, verify returns `false`
14. **Install - Full setup**: Mock exec calls, verify GPG key addition, repository addition, PostgreSQL installation, service enable/start, database/user creation, port check
15. **Install - PostgreSQL already installed**: Mock PostgreSQL installed, verify only service and port are checked
16. **Install - Service not enabled**: Mock service not enabled, verify enable command is executed
17. **Install - Service not running**: Mock service not running, verify start command is executed
18. **Install - Database exists**: Mock database exists, verify no new database is created
19. **Install - User exists**: Mock user exists, verify no new user is created
20. **Install - PostgreSQL disabled**: Test with `Postgres.Enabled=false`, verify skip message
21. **Install - Empty password**: Test with empty password, verify error is returned
22. **Install - Config defaults**: Test with minimal config, verify defaults are applied
23. **Dry-run mode**: Verify commands are logged but not executed in dry-run mode
24. **Idempotency**: Run `Install()` twice, verify second run is skipped (IsInstalled returns true)
25. **Error handling**: Test GPG key download errors, repository errors, installation errors, service start errors, port check errors, database/user creation errors, file operation errors
26. **Password security**: Verify passwords are never logged in any form

## Files Modified

- `internal/modules/postgres/postgres.go` (new) - PostgreSQL module implementation
- `internal/modules/postgres/postgres_test.go` (new) - Unit tests for PostgreSQL module
- `internal/config/config.go` (updated) - Add `Enabled`, `Database`, `User` fields to `Postgres` struct and update defaults
- `main.go` (updated) - Register PostgresModule in registerAllModules()
- `docs/api-specs/infrastructure/infrastructure-api.md` (updated) - Add PostgreSQL module API documentation
- `docs/delivery/6/6-1.md` (updated) - Update status history
- `docs/delivery/6/tasks.md` (updated) - Update task status

