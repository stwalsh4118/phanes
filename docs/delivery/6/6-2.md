# 6-2 Implement Redis module

[Back to task list](./tasks.md)

## Description

Implement the Redis module (`internal/modules/redis/redis.go`) that installs Redis from apt, configures Redis with optional password, binds to localhost by default for security, enables and starts the service, and verifies it is running and accessible. The module supports secure password handling and warns if binding to all interfaces without password.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 00:00:00 | Created | N/A | Proposed | Task file created | sean |
| 2025-01-27 00:00:00 | Status Update | Proposed | Done | Redis module implementation completed | sean |

## Requirements

1. Implement `module.Module` interface:
   - `Name() string` - Returns "redis"
   - `Description() string` - Returns "Installs and configures Redis in-memory data store"
   - `IsInstalled() (bool, error)` - Checks if Redis is installed and running
   - `Install(cfg *config.Config) error` - Installs and configures Redis

2. Install Redis from apt:
   - Update apt package list: `apt-get update`
   - Install Redis package: `apt-get install -y redis-server`
   - Verify Redis is installed: `redis-cli --version` or `redis-server --version`

3. Configure Redis:
   - Redis config file: `/etc/redis/redis.conf`
   - Bind to localhost by default: Set `bind 127.0.0.1` in config file
   - Use bind address from `cfg.Redis.BindAddress` (default "127.0.0.1" if not specified)
   - Configure password if provided: Set `requirepass <password>` in config file
   - Use password from `cfg.Redis.Password` (optional, empty means no password)
   - Warn if binding to all interfaces (`0.0.0.0` or `::`) without password configured
   - Reload Redis configuration: `systemctl reload redis-server` or restart service

4. Configure Redis service:
   - Check if service is enabled: `systemctl is-enabled redis-server`
   - Enable service if not enabled: `systemctl enable redis-server`
   - Check if service is running: `systemctl is-active redis-server`
   - Start service if not running: `systemctl start redis-server`
   - Verify service is running: `systemctl is-active redis-server`

5. Verify Redis is accessible:
   - Test connection: `redis-cli ping` (should return PONG)
   - If password is configured, test with: `redis-cli -a <password> ping`
   - Check if Redis is listening on port 6379: `ss -tlnp | grep :6379` or `netstat -tlnp | grep :6379`
   - Log success message with connection details

6. Configuration flags:
   - Respect `cfg.Redis.Enabled` flag (default `true`)
   - If `Enabled` is `false`, skip installation and log skip message
   - If `Enabled` is `true`, proceed with installation
   - Use `cfg.Redis.Password` (optional, empty means no password)
   - Use `cfg.Redis.BindAddress` (default "127.0.0.1" if empty)

7. Security considerations:
   - Bind to localhost by default (127.0.0.1) for security
   - Warn if binding to all interfaces (0.0.0.0 or ::) without password
   - Never log passwords in any form
   - Ensure passwords are not visible in process lists or config file logs

8. Idempotency:
   - `IsInstalled()` should check:
     - Redis is installed (`redis-cli --version` succeeds or package exists)
     - Redis service is running (`systemctl is-active redis-server` returns "active")
     - Redis is listening on port 6379
     - Redis responds to ping command
   - Return `true` if all checks pass, `false` otherwise
   - Return error if checks fail

9. Error handling:
    - Handle apt update errors
    - Handle Redis installation errors
    - Handle configuration file errors
    - Handle service start/enable errors
    - Handle port accessibility check errors
    - Handle Redis ping test errors
    - Log errors using `log.Error()`
    - Return descriptive errors

10. Dry-run support:
    - Check dry-run mode from logging package
    - In dry-run mode, log what would be done but don't execute commands
    - Still check current Redis installation status

11. Logging:
    - Use `log.Info()` for progress messages (especially during installation)
    - Use `log.Success()` when operations complete
    - Use `log.Skip()` when module is already installed or disabled
    - Use `log.Warn()` when security issues are detected (binding to all interfaces without password)
    - Show Redis connection details after installation (without password)
    - Never log passwords or sensitive information

## Implementation Plan

1. Create `internal/modules/redis/` directory
2. Create `redis.go` with package declaration
3. Import required packages:
   - `github.com/stwalsh4118/phanes/internal/module`
   - `github.com/stwalsh4118/phanes/internal/config`
   - `github.com/stwalsh4118/phanes/internal/exec`
   - `github.com/stwalsh4118/phanes/internal/log`
   - `fmt` (for string formatting)
   - `os` (for file operations)
   - `strings` (for string operations)
   - `bufio` (for reading config file line by line)

4. Define `RedisModule` struct:
   ```go
   type RedisModule struct{}
   ```

5. Define constants:
   - Redis service name: `redis-server`
   - Redis default port: `6379`
   - Redis config file path: `/etc/redis/redis.conf`
   - Default bind address: `"127.0.0.1"`
   - Redis package name: `"redis-server"`

6. Implement `Name()` method:
   - Return "redis"

7. Implement `Description()` method:
   - Return "Installs and configures Redis in-memory data store"

8. Implement helper function `redisInstalled() (bool, error)`:
   - Check if `redis-cli` binary exists: `/usr/bin/redis-cli` or `which redis-cli`
   - Or run `redis-cli --version` and check if it succeeds
   - Or check if package is installed: `dpkg -l | grep redis-server`
   - Return true if installed, false otherwise

9. Implement helper function `redisServiceRunning() (bool, error)`:
   - Run `systemctl is-active redis-server` and check if it returns "active"
   - Return true if running, false otherwise

10. Implement helper function `redisServiceEnabled() (bool, error)`:
    - Run `systemctl is-enabled redis-server` and check if it returns "enabled" or "enabled-runtime"
    - Return true if enabled, false otherwise

11. Implement helper function `redisPortAccessible() (bool, error)`:
    - Try `ss -tlnp` first (more modern), fallback to `netstat -tlnp`
    - Check if port 6379 is in the output: `:6379`
    - Return true if port is accessible, false otherwise
    - Return error if both commands fail

12. Implement helper function `redisRespondsToPing(password string) (bool, error)`:
    - If password is empty, run `redis-cli ping`
    - If password is set, run `redis-cli -a <password> ping`
    - Check if output contains "PONG"
    - Return true if Redis responds, false otherwise
    - Return error if command fails

13. Implement helper function `readRedisConfig() (map[string]string, error)`:
    - Read `/etc/redis/redis.conf` line by line
    - Parse key-value pairs (lines starting with key, followed by value)
    - Handle commented lines (skip lines starting with `#`)
    - Return map of configuration keys to values
    - Return error if file read fails

14. Implement helper function `redisConfigValue(key string) (string, bool, error)`:
    - Read Redis config file using `readRedisConfig()`
    - Look for the specified key
    - Return value and true if found, empty string and false if not found
    - Return error if config read fails

15. Implement helper function `updateRedisConfig(key, value string) error`:
    - Read current config file
    - Update or add the specified key-value pair
    - Handle commented lines (uncomment if key exists commented)
    - Write updated config back to file
    - Return error if file operations fail

16. Implement helper function `isBindingToAllInterfaces(bindAddress string) bool`:
    - Check if bind address is "0.0.0.0" or "::"
    - Return true if binding to all interfaces, false otherwise

17. Implement helper function `configureRedisBind(bindAddress string) error`:
    - Update Redis config file with `bind <bindAddress>`
    - Use `updateRedisConfig("bind", bindAddress)`
    - Return error if configuration fails

18. Implement helper function `configureRedisPassword(password string) error`:
    - If password is empty, remove `requirepass` directive or comment it out
    - If password is set, update Redis config file with `requirepass <password>`
    - Use `updateRedisConfig("requirepass", password)`
    - Return error if configuration fails

19. Implement helper function `reloadRedisConfig() error`:
    - Try to reload Redis: `systemctl reload redis-server`
    - If reload fails, restart Redis: `systemctl restart redis-server`
    - Verify service is still running after reload/restart
    - Return error if reload/restart fails

20. Implement `IsInstalled()` method:
    - Check if Redis is installed using `redisInstalled()`
    - Check if Redis service is running using `redisServiceRunning()`
    - Check if Redis port is accessible using `redisPortAccessible()`
    - Check if Redis responds to ping using `redisRespondsToPing("")` (no password check in IsInstalled)
    - Return `true` if all checks pass, `false` otherwise
    - Return error if checks fail

21. Implement `Install()` method:
    - Check dry-run mode
    - Check `cfg.Redis.Enabled` flag:
      - If `false`, log skip message and return nil
      - If `true`, proceed with installation
    - Get bind address from config (default to "127.0.0.1" if empty)
    - Get password from config (optional, empty means no password)
    - Check if binding to all interfaces without password:
      - If `isBindingToAllInterfaces(bindAddress)` and password is empty, log warning
    - Check if Redis is already installed:
      - If installed, verify service is running and port is accessible
      - If not installed, proceed with installation
    - Install Redis:
      - Update apt: `exec.Run("apt-get", "update")`
      - Install: `exec.Run("apt-get", "install", "-y", "redis-server")`
      - Verify: `exec.Run("redis-cli", "--version")`
    - Configure Redis:
      - Check current bind address in config
      - If different from desired, update using `configureRedisBind(bindAddress)`
      - Check current password in config
      - If different from desired, update using `configureRedisPassword(password)`
      - Reload Redis configuration using `reloadRedisConfig()`
    - Configure Redis service:
      - Check if enabled using `redisServiceEnabled()`
      - If not enabled, enable: `exec.Run("systemctl", "enable", "redis-server")`
      - Check if running using `redisServiceRunning()`
      - If not running, start: `exec.Run("systemctl", "start", "redis-server")`
      - Verify running: `exec.Run("systemctl", "is-active", "redis-server")`
    - Verify Redis is accessible:
      - Check port using `redisPortAccessible()`
      - Test ping using `redisRespondsToPing(password)`
      - Log success message with connection details (without password)
    - Log success message
    - Return error if any step fails

22. Update config structure in `internal/config/config.go`:
    - Add `Enabled bool` field to `Redis` struct
    - Add `BindAddress string` field to `Redis` struct
    - Update `DefaultConfig()` to set defaults:
      - `Enabled: true`
      - `Password: ""`
      - `BindAddress: "127.0.0.1"`

23. Register module in `main.go`:
    - Add import: `"github.com/stwalsh4118/phanes/internal/modules/redis"`
    - Add registration: `r.RegisterModule(&redis.RedisModule{})`

24. Create unit tests in `redis_test.go`:
    - Test `Name()` and `Description()`
    - Test `redisInstalled()` with mocked file/exec checks
    - Test `redisServiceRunning()` with mocked exec calls
    - Test `redisServiceEnabled()` with mocked exec calls
    - Test `redisPortAccessible()` with mocked exec calls
    - Test `redisRespondsToPing()` with mocked exec calls (with and without password)
    - Test `readRedisConfig()` with mocked file reads
    - Test `redisConfigValue()` with mocked config reads
    - Test `updateRedisConfig()` with mocked file operations
    - Test `isBindingToAllInterfaces()` with various addresses
    - Test `configureRedisBind()` with mocked config updates
    - Test `configureRedisPassword()` with mocked config updates (ensure password not logged)
    - Test `reloadRedisConfig()` with mocked exec calls
    - Test `IsInstalled()` with various scenarios
    - Test `Install()` with mocked exec calls
    - Test `Redis.Enabled=false` scenario
    - Test bind address configuration
    - Test password configuration (with and without password)
    - Test warning when binding to all interfaces without password
    - Test dry-run mode
    - Test error handling

## Verification

1. Module implements `module.Module` interface correctly
2. `Name()` returns "redis"
3. `Description()` returns correct description
4. `IsInstalled()` correctly checks Redis installation, service status, port accessibility, and ping response
5. `Install()` installs Redis, configures bind address and password, enables and starts service, and verifies accessibility
6. Redis service is enabled and started correctly
7. Redis port accessibility is verified
8. Redis responds to ping command
9. Bind address is configured correctly (defaults to localhost)
10. Password is configured correctly (optional)
11. Warning is shown when binding to all interfaces without password
12. Passwords are never logged
13. `cfg.Redis.Enabled` flag is respected
14. Config defaults are applied correctly
15. Module is idempotent (can run multiple times safely)
16. Error handling works correctly
17. Dry-run mode is respected
18. All logging is appropriate
19. Unit tests pass

## Test Plan

1. **Name and Description**: Verify `Name()` and `Description()` return correct values
2. **Redis Installed Check**: Mock file/exec checks, verify installation detection
3. **Redis Service Check**: Mock `systemctl is-active`, verify service status check
4. **Redis Service Enabled Check**: Mock `systemctl is-enabled`, verify enabled check
5. **Redis Port Check**: Mock `ss`/`netstat`, verify port accessibility check
6. **Redis Ping Check**: Mock `redis-cli ping`, verify ping response check
7. **Redis Ping with Password**: Mock `redis-cli -a <password> ping`, verify ping with password
8. **Read Redis Config**: Mock file read, verify config parsing
9. **Redis Config Value**: Mock config read, verify value retrieval
10. **Update Redis Config**: Mock file operations, verify config update
11. **Binding to All Interfaces Check**: Test with various addresses, verify detection
12. **Configure Bind Address**: Mock config update, verify bind address configuration
13. **Configure Password**: Mock config update, verify password configuration (ensure password not logged)
14. **Reload Redis Config**: Mock exec calls, verify reload/restart
15. **IsInstalled - Fully configured**: Mock all checks to return true, verify returns `true`
16. **IsInstalled - Not configured**: Mock checks to return false, verify returns `false`
17. **Install - Full setup**: Mock exec calls, verify Redis installation, config update, service enable/start, port check, ping test
18. **Install - Redis already installed**: Mock Redis installed, verify only service and port are checked
19. **Install - Service not enabled**: Mock service not enabled, verify enable command is executed
20. **Install - Service not running**: Mock service not running, verify start command is executed
21. **Install - Bind address update**: Mock different bind address in config, verify update is applied
22. **Install - Password update**: Mock different password in config, verify update is applied
23. **Install - Redis disabled**: Test with `Redis.Enabled=false`, verify skip message
24. **Install - Bind to all interfaces without password**: Test with `BindAddress="0.0.0.0"` and empty password, verify warning is logged
25. **Install - Config defaults**: Test with minimal config, verify defaults are applied
26. **Dry-run mode**: Verify commands are logged but not executed in dry-run mode
27. **Idempotency**: Run `Install()` twice, verify second run is skipped (IsInstalled returns true)
28. **Error handling**: Test apt update errors, installation errors, service start errors, port check errors, ping test errors, config file errors
29. **Password security**: Verify passwords are never logged in any form

## Files Modified

- `internal/modules/redis/redis.go` (new) - Redis module implementation
- `internal/modules/redis/redis_test.go` (new) - Unit tests for Redis module
- `internal/config/config.go` (updated) - Add `Enabled` and `BindAddress` fields to `Redis` struct and update defaults
- `main.go` (updated) - Register RedisModule in registerAllModules()
- `docs/api-specs/infrastructure/infrastructure-api.md` (updated) - Add Redis module API documentation
- `docs/delivery/6/6-2.md` (updated) - Update status history
- `docs/delivery/6/tasks.md` (updated) - Update task status

