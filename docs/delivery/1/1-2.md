# 1-2 Create exec package

[Back to task list](./tasks.md)

## Description

Create an exec package (`internal/exec/exec.go`) that provides safe command execution helpers. Functions should handle errors properly and provide utilities for checking command/file existence and writing files.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 00:00:00 | Created | N/A | Proposed | Task file created | sean |
| 2025-01-27 00:00:00 | Status Update | Proposed | InProgress | Started implementation | sean |
| 2025-01-27 00:00:00 | Status Update | InProgress | Review | Implementation complete, all tests passing | sean |
| 2025-01-27 00:00:00 | Status Update | Review | Done | Task approved and completed | sean |

## Requirements

1. Package located at `internal/exec/exec.go`
2. Functions:
   - `Run(name string, args ...string) error` - Execute command, return error
   - `RunWithOutput(name string, args ...string) (string, error)` - Execute and capture stdout
   - `CommandExists(cmd string) bool` - Check if command exists in PATH
   - `FileExists(path string) bool` - Check if file exists
   - `WriteFile(path string, content []byte, perm os.FileMode) error` - Write file with permissions
3. All functions should handle errors gracefully
4. Use `os/exec` for command execution
5. Use `os` package for file operations

## Implementation Plan

1. Create `internal/exec/` directory
2. Create `exec.go` with package declaration
3. Implement `Run()`:
   - Create `exec.Command` with name and args
   - Set stdout/stderr to os.Stdout/Stderr
   - Run command and return error
4. Implement `RunWithOutput()`:
   - Create `exec.Command`
   - Capture stdout with `cmd.Output()`
   - Return output string and error
5. Implement `CommandExists()`:
   - Use `exec.LookPath(cmd)`
   - Return true if no error
6. Implement `FileExists()`:
   - Use `os.Stat(path)`
   - Check if error is `os.ErrNotExist`
7. Implement `WriteFile()`:
   - Use `os.WriteFile()` with permissions
   - Return error
8. Add basic unit tests

## Verification

1. `Run()` executes commands and returns errors correctly
2. `RunWithOutput()` captures stdout correctly
3. `CommandExists()` correctly identifies existing/non-existing commands
4. `FileExists()` correctly identifies existing/non-existing files
5. `WriteFile()` creates files with correct permissions
6. Unit tests pass

## Files Modified

- `internal/exec/exec.go` (new) - Implemented exec package with all required functions
- `internal/exec/exec_test.go` (new) - Comprehensive unit tests covering all functions
- `docs/api-specs/infrastructure/infrastructure-api.md` (updated) - Added exec package API documentation

## Implementation Notes

### Implementation Details

1. **Exec package structure**:
   - Created `internal/exec/exec.go` with all five required functions
   - All functions follow Go best practices with proper error handling
   - Used standard library packages (`os`, `os/exec`) only

2. **Key design decisions**:
   - `Run()` connects stdout/stderr to os.Stdout/Stderr for direct output
   - `RunWithOutput()` uses `cmd.Output()` which captures stdout only (stderr is not captured)
   - `CommandExists()` uses `exec.LookPath()` which searches PATH
   - `FileExists()` uses `os.Stat()` and checks if error is nil (simpler than checking for `os.ErrNotExist`)
   - `WriteFile()` wraps `os.WriteFile()` for consistency with package API

3. **Testing approach**:
   - Created comprehensive unit tests for all functions
   - Tests cover successful cases, error cases, and edge cases
   - Used `t.TempDir()` for file system tests to ensure cleanup
   - Added test for file overwrite behavior
   - Tests verify permissions on Unix-like systems

### Code Quality

- ✅ `go fmt` - Code is properly formatted
- ✅ `go vet` - No static analysis issues
- ✅ All unit tests pass
- ✅ Proper error handling (no panics)
- ✅ Follows Go best practices
- ✅ Uses only standard library packages

### Verification Results

1. ✅ `Run()` executes commands and returns errors correctly
2. ✅ `RunWithOutput()` captures stdout correctly
3. ✅ `CommandExists()` correctly identifies existing/non-existing commands
4. ✅ `FileExists()` correctly identifies existing/non-existing files
5. ✅ `WriteFile()` creates files with correct permissions
6. ✅ All unit tests pass

