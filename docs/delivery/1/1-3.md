# 1-3 Create config package

[Back to task list](./tasks.md)

## Description

Create a config package (`internal/config/config.go`) that defines the configuration structure, loads YAML files, and validates configuration. The config should support all module settings with sensible defaults.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 00:00:00 | Created | N/A | Proposed | Task file created | sean |
| 2025-01-27 00:00:00 | Status Update | Proposed | InProgress | Started implementation | sean |
| 2025-01-27 00:00:00 | Status Update | InProgress | Review | Implementation complete, all tests passing | sean |
| 2025-01-27 00:00:00 | Status Update | Review | Done | Task approved and completed | sean |

## Requirements

1. Package located at `internal/config/config.go`
2. Define `Config` struct with YAML tags for all settings:
   - User settings (username, SSH key, timezone)
   - Swap configuration
   - Security settings
   - Docker settings
   - Postgres settings
   - Redis settings
   - Web server settings
   - Dev tools settings
   - Coolify settings
3. Function `Load(path string) (*Config, error)` - Load and parse YAML file
4. Function `Validate(cfg *Config) error` - Validate required fields
5. Provide sensible defaults for optional fields
6. Use `gopkg.in/yaml.v3` for YAML parsing

## Implementation Plan

1. Create `internal/config/` directory
2. Create `config.go` with package declaration
3. Define `Config` struct with nested structs for organization:
   - `User` struct (username, ssh_public_key)
   - `System` struct (timezone)
   - `Swap` struct (enabled, size)
   - `Security` struct (ssh_port, allow_password_auth)
   - `Docker` struct (install_compose)
   - `Postgres` struct (version, password)
   - `Redis` struct (password)
   - `Nginx` struct (enabled)
   - `Caddy` struct (enabled)
   - `DevTools` struct (node_version, python_version, go_version)
   - `Coolify` struct (enabled)
4. Implement `Load()`:
   - Read file with `os.ReadFile`
   - Unmarshal YAML with `yaml.Unmarshal`
   - Apply defaults
   - Validate
   - Return config and error
5. Implement `Validate()`:
   - Check required fields (username, ssh_public_key)
   - Return descriptive errors
6. Add `DefaultConfig()` helper for defaults
7. Add basic unit tests

## Verification

1. `Load()` correctly parses valid YAML files
2. `Load()` applies defaults for missing fields
3. `Validate()` catches missing required fields
4. `Validate()` returns clear error messages
5. Unit tests pass

## Files Modified

- `internal/config/config.go` (new) - Implemented config package with Config struct, Load(), Validate(), and DefaultConfig()
- `internal/config/config_test.go` (new) - Comprehensive unit tests covering all functions and edge cases
- `go.mod` (updated) - Added gopkg.in/yaml.v3 v3.0.1 dependency
- `docs/api-specs/infrastructure/infrastructure-api.md` (updated) - Added config package API documentation

## Implementation Notes

### Implementation Details

1. **Config package structure**:
   - Created `internal/config/config.go` with complete Config struct and nested structs
   - All structs use YAML tags matching the configuration file format
   - Organized into logical groups: User, System, Swap, Security, Docker, Postgres, Redis, Nginx, Caddy, DevTools, Coolify

2. **Key design decisions**:
   - Used `gopkg.in/yaml.v3` for YAML parsing (industry standard)
   - `Load()` function reads file, unmarshals YAML, applies defaults, and validates in one call
   - `DefaultConfig()` provides sensible defaults for all optional fields
   - `Validate()` checks required fields (username, ssh_public_key) and returns clear error messages
   - Defaults are applied before validation, so partial configs work correctly

3. **Testing approach**:
   - Created comprehensive unit tests for all functions
   - Tests cover: default values, validation (nil, missing fields), loading valid/invalid YAML, partial overrides
   - Tests verify defaults are applied correctly when fields are missing
   - Tests verify validation catches missing required fields
   - Tests verify partial configs work (some fields override defaults, others use defaults)

### Code Quality

- ✅ `go fmt` - Code is properly formatted
- ✅ `go vet` - No static analysis issues
- ✅ All unit tests pass
- ✅ Proper error handling (no panics)
- ✅ Follows Go best practices
- ✅ Clear, descriptive error messages

### Verification Results

1. ✅ `Load()` correctly parses valid YAML files
2. ✅ `Load()` applies defaults for missing fields
3. ✅ `Validate()` catches missing required fields
4. ✅ `Validate()` returns clear error messages
5. ✅ All unit tests pass
6. ✅ Partial configs work correctly (mix of provided and default values)

