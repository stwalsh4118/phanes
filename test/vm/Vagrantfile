# -*- mode: ruby -*-
# vi: set ft=ruby :

# Vagrantfile optimized for running Vagrant natively on Windows
# (even when developing in WSL)

# Get the project root - works whether called from Windows or WSL
vagrant_dir = File.dirname(__FILE__)
project_root = File.expand_path(File.join(vagrant_dir, "..", ".."))

Vagrant.configure("2") do |config|
  config.vm.box = "bento/ubuntu-22.04"
  config.vm.hostname = "phanes-test"
  
  config.vm.provider "virtualbox" do |vb|
    vb.name = "phanes-test-vm"
    vb.memory = "2048"
    vb.cpus = 2
  end
  
  # Network - forward SSH port
  config.vm.network "forwarded_port", guest: 22, host: 2222, id: "ssh"
  
  # Forward Netdata monitoring port
  config.vm.network "forwarded_port", guest: 19999, host: 19999, id: "netdata"
  
  # Forward HTTP and HTTPS ports for Nginx
  config.vm.network "forwarded_port", guest: 80, host: 80, id: "http"
  config.vm.network "forwarded_port", guest: 443, host: 443, id: "https"
  
  # Disable default /vagrant synced folder
  config.vm.synced_folder ".", "/vagrant", disabled: true
  
  # Sync project files using rsync
  # This works when Vagrant runs natively on Windows
  config.vm.synced_folder project_root, "/workspace",
    type: "rsync",
    rsync__exclude: [".git/", "test/vm/.vagrant/", ".vagrant/", "*.log"]
  
  # Provision VM with Go and dependencies
  config.vm.provision "shell", inline: <<-SHELL
    set -e
    echo "=== Provisioning Phanes Test VM ==="
    
    # Update package lists
    apt-get update -qq
    
    # Install essential packages
    apt-get install -y -qq curl git build-essential ca-certificates gnupg lsb-release
    
    # Install Go 1.21
    GO_VERSION="1.21.5"
    if [ ! -d "/usr/local/go" ]; then
      echo "Installing Go ${GO_VERSION}..."
      cd /tmp
      curl -fsSL "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz" -o go.tar.gz
      tar -C /usr/local -xzf go.tar.gz
      rm go.tar.gz
    fi
    
    # Add Go to PATH
    if ! grep -q "/usr/local/go/bin" /etc/profile; then
      echo 'export PATH=$PATH:/usr/local/go/bin' >> /etc/profile
    fi
    export PATH=$PATH:/usr/local/go/bin
    go version
    
    # Install system dependencies for modules
    apt-get install -y -qq ufw fail2ban openssh-server sudo locales
    
    # Generate locale
    locale-gen en_US.UTF-8
    
    # Set correct ownership for workspace
    chown -R vagrant:vagrant /workspace
    
    echo "=== Provisioning complete ==="
    echo "Go version: $(go version)"
  SHELL
  
  # SSH configuration - let Vagrant handle keys automatically
  config.ssh.insert_key = true
end
